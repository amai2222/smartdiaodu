<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0c0f" />
  <title>路线地图 · 全屏</title>
  <script src="config.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; min-height: 100vh; overflow: hidden; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; min-height: 300px; z-index: 0; background: #1a1a2e; }
    .toolbar {
      position: fixed;
      top: 12px;
      left: 12px;
      right: 12px;
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      pointer-events: none;
    }
    .toolbar > * { pointer-events: auto; }
    .toolbar .toolbar-label { padding: 10px 14px; font-size: 0.95rem; color: #e6edf3; }
    .toolbar select, .toolbar button, .toolbar a {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #2a2d35;
      background: rgba(20, 21, 26, 0.95);
      color: #e6edf3;
      font-size: 0.95rem;
      text-decoration: none;
    }
    .toolbar button { cursor: pointer; }
    .toolbar a { display: inline-block; }
    .toolbar .status { color: #8b9199; font-size: 0.85rem; }
    .nav-panel {
      position: fixed;
      bottom: 16px;
      left: 12px;
      right: 12px;
      z-index: 1000;
      padding: 14px;
      border-radius: 14px;
      background: rgba(20, 21, 26, 0.96);
      border: 1px solid #2a2d35;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .nav-panel * { pointer-events: auto; }
    .nav-panel .next-stop { font-size: 1rem; color: #e6edf3; }
    .nav-panel .btns { display: flex; gap: 10px; flex-wrap: wrap; }
    .nav-panel .btns a, .nav-panel .btns button {
      flex: 1;
      min-width: 120px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      border: none;
      cursor: pointer;
    }
    .nav-panel .btn-nav { background: #3b82f6; color: #fff; }
    .nav-panel .btn-arrived { background: #22c55e; color: #fff; }
    .nav-panel .all-done { color: #22c55e; font-size: 1.1rem; }
    #btnToggleUI { position: fixed; top: 12px; right: 12px; z-index: 1001; padding: 10px 14px; border-radius: 10px; border: 1px solid #2a2d35; background: rgba(20,21,26,0.95); color: #e6edf3; font-size: 0.95rem; cursor: pointer; display: none; }
    #btnToggleUI.show { display: block; }
    body.toolbar-hidden .toolbar { display: none !important; }
    body.toolbar-hidden #navPanel { display: none !important; }
    body.toolbar-hidden #allDonePanel { display: none !important; }
    /* 隐藏百度地图底部版权/署名栏 */
    #map .anchorBL,
    #map .BMap_cpyCtrl { display: none !important; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toolbar">
    <span class="toolbar-label">百度地图</span>
    <button type="button" id="btnRefresh">更新路线</button>
    <button type="button" id="btnRestore">恢复上次线路</button>
    <a href="index.html" target="_self">← 返回控制台</a>
    <span id="routeInfo" class="status"></span>
    <button type="button" id="btnCollapse" title="收起菜单">收起</button>
  </div>
  <button type="button" id="btnToggleUI" title="显示菜单">≡ 菜单</button>
  <div id="navPanel" class="nav-panel" style="display: none;">
    <div id="nextStopText" class="next-stop"></div>
    <div class="btns">
      <a id="btnOpenNav" href="#" target="_blank" rel="noopener" class="btn-nav">打开导航</a>
      <button type="button" id="btnArrived" class="btn-arrived">已到达</button>
    </div>
  </div>
  <div id="allDonePanel" class="nav-panel" style="display: none;">
    <span class="all-done">✅ 全部送达</span>
    <a href="index.html" target="_self" class="btn-nav" style="text-align:center;">返回控制台</a>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
(function () {
  var STORAGE_API = "smartdiaodu_api_base";
  var STORAGE_DRIVER_LOC = "smartdiaodu_driver_loc";
  var STORAGE_PICKUPS = "smartdiaodu_pickups";
  var STORAGE_DELIVERIES = "smartdiaodu_deliveries";
  var STORAGE_SUPABASE_URL = "smartdiaodu_supabase_url";
  var STORAGE_SUPABASE_ANON = "smartdiaodu_supabase_anon_key";
  var STORAGE_DRIVER_ID = "smartdiaodu_driver_id";
  var STORAGE_MAP_STOP_INDEX = "smartdiaodu_map_stop_index";
  var STORAGE_MAP_ROUTE_HASH = "smartdiaodu_map_route_hash";
  var DEFAULT_DRIVER_ID = "a0000001-0000-4000-8000-000000000001";

  /** 除 Supabase URL/Anon 外，其余配置仅从数据库 app_config 读取 */
  var cachedAppConfig = { api_base: "", baidu_map_ak: "", driver_id: "" };
  function loadAppConfig(cb) {
    var sup = getSupabaseClient();
    if (!sup) { if (cb) cb(); return; }
    sup.from("app_config").select("key, value").then(function (r) {
      if (r.data && Array.isArray(r.data)) {
        r.data.forEach(function (row) {
          var k = row.key, v = (row.value || "").trim();
          if (k === "api_base") cachedAppConfig.api_base = v.replace(/\/$/, "");
          else if (k === "baidu_map_ak") cachedAppConfig.baidu_map_ak = v;
          else if (k === "driver_id") cachedAppConfig.driver_id = v;
        });
      }
      if (cb) cb();
    }).catch(function () { if (cb) cb(); });
  }
  function getApiBase() { return cachedAppConfig.api_base || ""; }
  function getSupabaseUrl() { return (typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_SUPABASE_URL) : "") || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.supabaseUrl) || ""; }
  function getSupabaseAnon() { return (typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_SUPABASE_ANON) : "") || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.supabaseAnonKey) || ""; }
  function getDriverId() { return cachedAppConfig.driver_id || DEFAULT_DRIVER_ID; }
  function getSupabaseClient() {
    var url = getSupabaseUrl(), anon = getSupabaseAnon();
    if (!url || !anon || !window.supabase) return null;
    return window.supabase.createClient(url, anon);
  }
  /** 地图底图仅从数据库 app_config 的 baidu_map_ak 读取 */
  function getBaiduMapAk() { return cachedAppConfig.baidu_map_ak || ""; }
  function getCurrentState() {
    var driver_loc = (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_DRIVER_LOC)) || "";
    var pickups = [], deliveries = [];
    try {
      var p = localStorage.getItem(STORAGE_PICKUPS), d = localStorage.getItem(STORAGE_DELIVERIES);
      if (p) pickups = JSON.parse(p);
      if (d) deliveries = JSON.parse(d);
    } catch (e) {}
    return { driver_loc: driver_loc || "如东县委党校", pickups: pickups, deliveries: deliveries };
  }

  /** 从数据库加载当前计划：司机位置 + 已分配订单的接/送地址，用于地图显示规划线路 */
  function loadStateFromSupabase(cb) {
    var sup = getSupabaseClient();
    if (!sup) { if (cb) cb(getCurrentState()); return; }
    var driverId = getDriverId();
    sup.from("driver_state").select("current_loc").eq("driver_id", driverId).maybeSingle()
      .then(function (r) {
        var driver_loc = (r.data && r.data.current_loc) ? String(r.data.current_loc).trim() : "";
        return sup.from("order_pool").select("pickup, delivery").eq("assigned_driver_id", driverId).eq("status", "assigned").order("id")
          .then(function (orders) {
            var pickups = [], deliveries = [];
            if (orders.data && Array.isArray(orders.data)) {
              orders.data.forEach(function (o) {
                pickups.push(o.pickup || "");
                deliveries.push(o.delivery || "");
              });
            }
            var state = {
              driver_loc: driver_loc || "如东县委党校",
              pickups: pickups,
              deliveries: deliveries
            };
            if (typeof localStorage !== "undefined") {
              localStorage.setItem(STORAGE_DRIVER_LOC, state.driver_loc);
              localStorage.setItem(STORAGE_PICKUPS, JSON.stringify(state.pickups));
              localStorage.setItem(STORAGE_DELIVERIES, JSON.stringify(state.deliveries));
            }
            if (cb) cb(state);
            return state;
          });
      })
      .catch(function () { if (cb) cb(getCurrentState()); });
  }

  var bmap = null, lastRouteData = null;
  var route_addresses = [], route_coords = [], point_types = [], point_labels = [];
  var currentStopIndex = 0;

  function wgs84ToBd09(lat, lng) {
    var x_PI = (3.14159265358979324 * 3000.0) / 180.0, a = 6378245.0, ee = 0.00669342162296594323;
    function trLat(x, y) {
      var r = -100 + 2 * x + 3 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
      r += (20 * Math.sin(6 * x * Math.PI) + 20 * Math.sin(2 * x * Math.PI)) * 2 / 3;
      r += (20 * Math.sin(y * Math.PI) + 40 * Math.sin(y / 3 * Math.PI)) * 2 / 3;
      return r;
    }
    function trLng(x, y) {
      var r = 300 + x + 2 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
      r += (20 * Math.sin(6 * x * Math.PI) + 20 * Math.sin(2 * x * Math.PI)) * 2 / 3;
      r += (20 * Math.sin(x * Math.PI) + 40 * Math.sin(x / 3 * Math.PI)) * 2 / 3;
      return r;
    }
    var dlat = trLat(lng - 105, lat - 35), dlng = trLng(lng - 105, lat - 35);
    var radlat = (lat / 180) * Math.PI, magic = 1 - ee * Math.sin(radlat) * Math.sin(radlat), sqrtmagic = Math.sqrt(magic);
    dlat = (dlat * 180) / ((a * (1 - ee)) / (magic * sqrtmagic) * Math.PI);
    dlng = (dlng * 180) / (a / sqrtmagic * Math.cos(radlat) * Math.PI);
    var mglat = lat + dlat, mglng = lng + dlng;
    return [mglng + 0.0065 * Math.cos(mglat * x_PI), mglat + 0.006 * Math.sin(mglng * x_PI)];
  }

  /** 单点调起导航（仅终点，无途经点） */
  function getNavUrl(lat, lng, name) {
    var bd = wgs84ToBd09(lat, lng);
    if (!bd || bd[0] == null || bd[1] == null) return "#";
    var dest = bd[1] + "," + bd[0];
    return "baidumap://map/direction?destination=name:" + encodeURIComponent(name || "") + "|latlng:" + dest + "&mode=driving";
  }

  /**
   * 调起百度地图 App 导航：起点 + 途经点 + 终点（最多 15 个途经点）
   * 格式：origin=我的位置&destination=终点&waypoints=途经1|途经2&mode=driving
   */
  function getNavUrlWithWaypoints() {
    var nextIdx = currentStopIndex + 1;
    if (nextIdx >= route_addresses.length) return "#";
    var origin = "我的位置";
    var destAddr = route_addresses[route_addresses.length - 1] || "";
    var waypointsArr = [];
    for (var i = nextIdx; i < route_addresses.length - 1 && waypointsArr.length < 15; i++) {
      var a = (route_addresses[i] || "").trim();
      if (a) waypointsArr.push(encodeURIComponent(a));
    }
    var params = [
      "origin=" + encodeURIComponent(origin),
      "destination=" + encodeURIComponent(destAddr),
      "mode=driving"
    ];
    if (waypointsArr.length > 0) params.push("waypoints=" + waypointsArr.join("|"));
    return "baidumap://map/direction?" + params.join("&");
  }

  function destroyMap() {
    if (bmap) { try { bmap.destroy(); } catch (e) {} bmap = null; }
  }

  function initMap() {
    var ak = (getBaiduMapAk() || "").trim();
    if (!ak) {
      document.getElementById("routeInfo").textContent = "请在 app_config 中配置 baidu_map_ak（网页端 AK）";
      return;
    }
    destroyMap();
    if (!window.BMap) {
      window.baiduMapReady = function () {
        window.baiduMapReady = null;
        if (!window.BMap || typeof window.BMap.Map !== "function") {
          document.getElementById("routeInfo").textContent = "百度地图 API 未就绪（脚本可能被拦截或返回错误）。请打开 F12 → Network，查看 api.map.baidu.com 是否返回 403，并确认 AK 与白名单正确。";
          return;
        }
        initBaiduMap();
        if (lastRouteData) drawRouteFromIndex(currentStopIndex);
      };
      var script = document.createElement("script");
      script.src = "https://api.map.baidu.com/api?v=3.0&ak=" + encodeURIComponent(ak) + "&s=1&callback=baiduMapReady";
      script.onerror = function () {
        document.getElementById("routeInfo").textContent = "百度地图脚本加载失败（网络或地址无效）。请检查 F12 → Network 中 api.map.baidu.com 请求。";
      };
      document.head.appendChild(script);
      return;
    }
    initBaiduMap();
    if (lastRouteData) drawRouteFromIndex(currentStopIndex);
  }

  function initBaiduMap() {
    if (bmap) return;
    if (!window.BMap || typeof window.BMap.Map !== "function") {
      console.warn("[地图] BMap 未定义，跳过初始化");
      return;
    }
    var container = document.getElementById("map");
    if (!container) return;
    bmap = new window.BMap.Map("map");
    bmap.centerAndZoom(new window.BMap.Point(121.0, 32.0), 10);
    bmap.enableScrollWheelZoom(true);
    if (typeof bmap.enableDragging === "function") bmap.enableDragging();
    if (typeof bmap.enableInertialDragging === "function") bmap.enableInertialDragging();
    if (typeof bmap.enableDoubleClickZoom === "function") bmap.enableDoubleClickZoom(true);
    // 瓦片加载完成/失败时在控制台输出，便于排查白屏
    if (typeof bmap.addEventListener === "function") {
      bmap.addEventListener("tilesloaded", function () { console.log("[地图] 瓦片已加载"); });
    }
    // 容器尺寸变化或延迟渲染时强制刷新，避免白屏
    setTimeout(function () {
      if (bmap && typeof bmap.invalidateSize === "function") bmap.invalidateSize();
    }, 200);
  }

  function clearMapOverlays() {
    if (bmap) bmap.clearOverlays();
  }

  /** 按实际驾车道路绘制路线：逐段调用百度驾车路线规划，再画折线；失败则退回直线 */
  function drawRouteFromIndex(fromIndex) {
    if (!lastRouteData) return;
    var coords = route_coords.slice(fromIndex);
    var addresses = route_addresses.slice(fromIndex);
    var types = point_types.slice(fromIndex);
    var labels = point_labels.slice(fromIndex);
    document.getElementById("routeInfo").textContent = "剩余 " + (addresses.length - 1) + " 站";
    if (coords.length === 0) return;
    clearMapOverlays();
    if (!bmap) return;
    var bdPoints = [];
    var orderNums = ["①", "②", "③", "④", "⑤", "⑥", "⑦", "⑧", "⑨", "⑩"];
    for (var i = 0; i < coords.length; i++) {
      var c = coords[i];
      if (!c || c[0] == null || c[1] == null) continue;
      var bd = wgs84ToBd09(c[0], c[1]);
      if (!bd || bd[0] == null || bd[1] == null) continue;
      var pt = new window.BMap.Point(bd[0], bd[1]);
      bdPoints.push(pt);
      var num = fromIndex + i + 1;
      var orderStr = orderNums[num - 1] || num + ".";
      var typeLabel = labels[i] || types[i] || "途经";
      var addrShort = addresses[i] ? " " + addresses[i].slice(0, 10) + (addresses[i].length > 10 ? "…" : "") : "";
      var mk = new window.BMap.Marker(pt);
      mk.setLabel(new window.BMap.Label(orderStr + " " + typeLabel + addrShort, { offset: new window.BMap.Size(10, -10) }));
      bmap.addOverlay(mk);
    }
    if (bdPoints.length === 0) return;
    if (bdPoints.length === 1) {
      bmap.setCenter(bdPoints[0]);
      bmap.setZoom(14);
      return;
    }
    var allPathPoints = [];
    var segmentIndex = 0;
    function drawStraightLine() {
      bmap.addOverlay(new window.BMap.Polyline(bdPoints, { strokeColor: "#3b82f6", strokeWeight: 4 }));
      bmap.setViewport(bdPoints);
    }
    function onSegmentDone() {
      segmentIndex++;
      if (segmentIndex >= bdPoints.length - 1) {
        if (allPathPoints.length > 0) {
          bmap.addOverlay(new window.BMap.Polyline(allPathPoints, { strokeColor: "#3b82f6", strokeWeight: 4 }));
          bmap.setViewport(allPathPoints);
        } else {
          drawStraightLine();
        }
        document.getElementById("routeInfo").textContent = "剩余 " + (addresses.length - 1) + " 站";
        return;
      }
      requestDrivingSegment(segmentIndex);
    }
    function requestDrivingSegment(idx) {
      if (typeof window.BMap.DrivingRoute === "undefined") {
        drawStraightLine();
        return;
      }
      var start = bdPoints[idx];
      var end = bdPoints[idx + 1];
      var opts = { renderOptions: { map: null, autoViewport: false } };
      if (window.BMap.DrivingPolicy && window.BMap.DrivingPolicy.LEAST_TIME) opts.policy = window.BMap.DrivingPolicy.LEAST_TIME;
      var driving = new window.BMap.DrivingRoute(bmap, opts);
      driving.setSearchCompleteCallback(function () {
        try {
          var res = driving.getResults();
          if (res && res.getPlan && res.getPlan(0)) {
            var route = res.getPlan(0).getRoute(0);
            if (route && route.getPath) {
              var path = route.getPath();
              if (path && path.length > 0) {
                for (var k = 0; k < path.length; k++) allPathPoints.push(path[k]);
                onSegmentDone();
                return;
              }
            }
          }
        } catch (e) {}
        allPathPoints.push(start);
        allPathPoints.push(end);
        onSegmentDone();
      });
      driving.setErrorCallback(function () {
        allPathPoints.push(start);
        allPathPoints.push(end);
        onSegmentDone();
      });
      driving.search(start, end);
    }
    document.getElementById("routeInfo").textContent = "正在规划驾车路线…";
    requestDrivingSegment(0);
  }

  function updateNavPanel() {
    var nextIdx = currentStopIndex + 1;
    var navPanel = document.getElementById("navPanel");
    var allDonePanel = document.getElementById("allDonePanel");
    if (nextIdx >= route_addresses.length) {
      navPanel.style.display = "none";
      allDonePanel.style.display = "block";
      return;
    }
    allDonePanel.style.display = "none";
    navPanel.style.display = "block";
    var label = point_labels[nextIdx] || point_types[nextIdx] || ("第" + (nextIdx + 1) + "站");
    var addr = route_addresses[nextIdx] || "";
    document.getElementById("nextStopText").textContent = "下一站: " + label + " " + (addr.length > 18 ? addr.slice(0, 18) + "…" : addr);
    var a = document.getElementById("btnOpenNav");
    a.href = getNavUrlWithWaypoints();
    a.textContent = "打开导航（百度地图，含途经点）";
  }

  function saveStopIndex() {
    if (typeof localStorage !== "undefined") {
      localStorage.setItem(STORAGE_MAP_STOP_INDEX, String(currentStopIndex));
      localStorage.setItem(STORAGE_MAP_ROUTE_HASH, lastRouteData ? (route_addresses.join("|") || "") : "");
    }
  }

  /** 将接口或快照数据应用到全局并画图 */
  function applyRouteData(data) {
    route_addresses = data.route_addresses || [];
    route_coords = data.route_coords || [];
    point_types = data.point_types || [];
    point_labels = data.point_labels || [];
    lastRouteData = data;
    var hash = route_addresses.join("|");
    var savedHash = typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_MAP_ROUTE_HASH) : "";
    var savedIdx = typeof localStorage !== "undefined" ? parseInt(localStorage.getItem(STORAGE_MAP_STOP_INDEX), 10) : 0;
    currentStopIndex = (hash === savedHash && !isNaN(savedIdx)) ? Math.max(0, Math.min(savedIdx, route_addresses.length - 1)) : 0;
    saveStopIndex();
    initMap();
    drawRouteFromIndex(currentStopIndex);
    updateNavPanel();
    if (bmap && typeof bmap.invalidateSize === "function") bmap.invalidateSize();
  }

  /** 规划结果入库（每司机一条，覆盖） */
  function saveRouteSnapshot(data) {
    var sup = getSupabaseClient();
    if (!sup || !data || !(data.route_addresses && data.route_addresses.length)) return;
    var payload = {
      driver_id: getDriverId(),
      route_addresses: data.route_addresses,
      route_coords: data.route_coords || [],
      point_types: data.point_types || [],
      point_labels: data.point_labels || [],
      total_time_seconds: Math.max(0, parseInt(data.total_time_seconds, 10) || 0)
    };
    sup.from("driver_route_snapshot").upsert(payload, { onConflict: "driver_id" }).then(function () {});
  }

  /** 从数据库读取上次保存的线路快照 */
  function loadSavedRoute(cb) {
    var sup = getSupabaseClient();
    if (!sup) { if (cb) cb(null); return; }
    sup.from("driver_route_snapshot").select("route_addresses, route_coords, point_types, point_labels, total_time_seconds")
      .eq("driver_id", getDriverId()).maybeSingle()
      .then(function (r) {
        var d = r.data;
        if (d && Array.isArray(d.route_addresses) && d.route_addresses.length > 0 && Array.isArray(d.route_coords) && d.route_coords.length > 0) {
          if (cb) cb({
            route_addresses: d.route_addresses,
            route_coords: d.route_coords,
            point_types: Array.isArray(d.point_types) ? d.point_types : [],
            point_labels: Array.isArray(d.point_labels) ? d.point_labels : [],
            total_time_seconds: d.total_time_seconds || 0
          });
        } else {
          if (cb) cb(null);
        }
      })
      .catch(function () { if (cb) cb(null); });
  }

  function markArrived() {
    currentStopIndex++;
    var addr = route_addresses[currentStopIndex];
    var typ = point_types[currentStopIndex];
    if (addr && typeof localStorage !== "undefined") localStorage.setItem(STORAGE_DRIVER_LOC, addr);
    var sup = getSupabaseClient();
    if (sup) {
      sup.from("driver_state").update({ current_loc: addr || "" }).eq("driver_id", getDriverId()).then(function () {});
      if (typ === "delivery" && addr) {
        sup.from("order_pool").select("id").eq("delivery", addr).eq("assigned_driver_id", getDriverId()).eq("status", "assigned").limit(1)
          .then(function (r) {
            var row = r.data && r.data[0];
            if (row && row.id) {
              sup.from("order_pool").update({ status: "completed", assigned_driver_id: null }).eq("id", row.id).then(function () {});
              sup.from("driver_state").select("empty_seats").eq("driver_id", getDriverId()).maybeSingle().then(function (rr) {
                var next = (rr.data && rr.data.empty_seats != null) ? Math.min(4, rr.data.empty_seats + 1) : 1;
                sup.from("driver_state").update({ empty_seats: next }).eq("driver_id", getDriverId()).then(function () {});
              });
            }
          });
      }
    }
    saveStopIndex();
    drawRouteFromIndex(currentStopIndex);
    updateNavPanel();
  }

  document.getElementById("btnArrived").onclick = markArrived;

  document.getElementById("btnCollapse").onclick = function () {
    document.body.classList.add("toolbar-hidden");
    document.getElementById("btnToggleUI").classList.add("show");
  };
  document.getElementById("btnToggleUI").onclick = function () {
    document.body.classList.remove("toolbar-hidden");
    document.getElementById("btnToggleUI").classList.remove("show");
  };

  function loadAndDraw() {
    var base = getApiBase();
    var statusEl = document.getElementById("routeInfo");
    if (!base) {
      initMap();
      loadSavedRoute(function (data) {
        if (data) {
          applyRouteData(data);
          statusEl.textContent = "已恢复上次线路（共 " + route_addresses.length + " 站）；未配置 apiBase 无法重新规划";
        } else {
          statusEl.textContent = "未配置后端（请在 Supabase 表 app_config 中设置 key=api_base）";
        }
      });
      return;
    }
    statusEl.textContent = "从数据库加载计划…";
    loadStateFromSupabase(function (state) {
      statusEl.textContent = "规划路线中…";
      fetch(base + "/current_route_preview", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ current_state: state })
      })
      .then(function (r) { if (!r.ok) return r.json().then(function (d) { throw new Error(d.detail || r.statusText); }); return r.json(); })
      .then(function (data) {
        applyRouteData(data);
        saveRouteSnapshot(data);
        document.getElementById("routeInfo").textContent = "共 " + route_addresses.length + " 站，约 " + Math.round((data.total_time_seconds || 0) / 60) + " 分钟（已入库）";
      })
      .catch(function (e) {
        document.getElementById("navPanel").style.display = "none";
        initMap();
        var msg = e.message || String(e);
        var hint = "";
        if (/failed to fetch|networkerror|load failed/i.test(msg) && window.location.protocol === "https:") {
          hint = "（HTTPS 页面请求 HTTP 后端可能被浏览器拦截，请将后端改为 HTTPS 或在本机用 HTTP 打开页面）";
        } else if (/地址无法解析|地理编码|地址.*解析/i.test(msg)) {
          hint = "。请到控制台修改「我的位置」或乘客起终点为更详细地址（如带区县、街道）后重试「更新路线」";
        }
        document.getElementById("routeInfo").textContent = "路线加载失败：" + msg + hint + "，仅显示地图";
      });
    });
  }

  document.getElementById("btnRefresh").onclick = function () {
    if (typeof localStorage !== "undefined") {
      localStorage.removeItem(STORAGE_MAP_STOP_INDEX);
      localStorage.removeItem(STORAGE_MAP_ROUTE_HASH);
    }
    currentStopIndex = 0;
    loadAndDraw();
  };

  document.getElementById("btnRestore").onclick = function () {
    var statusEl = document.getElementById("routeInfo");
    statusEl.textContent = "加载中…";
    loadSavedRoute(function (data) {
      if (data) {
        applyRouteData(data);
        statusEl.textContent = "已恢复上次线路（共 " + route_addresses.length + " 站，约 " + Math.round((data.total_time_seconds || 0) / 60) + " 分钟）";
      } else {
        statusEl.textContent = "无已保存线路，请先点「更新路线」规划并入库";
        if (bmap) clearMapOverlays();
      }
    });
  };

  // 进入页面：先从数据库加载 app_config，再初始化地图与路线
  (function onLoad() {
    var statusEl = document.getElementById("routeInfo");
    statusEl.textContent = "加载配置…";
    loadAppConfig(function () {
      statusEl.textContent = "加载中…";
      initMap();
      loadSavedRoute(function (data) {
        if (data) {
          applyRouteData(data);
          statusEl.textContent = "已恢复上次线路（共 " + route_addresses.length + " 站，约 " + Math.round((data.total_time_seconds || 0) / 60) + " 分钟）";
        } else {
          loadAndDraw();
        }
      });
    });
  })();
})();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0c0f" />
  <title>路线地图 · 全屏</title>
  <script src="config.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    .toolbar {
      position: fixed;
      top: 12px;
      left: 12px;
      right: 12px;
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .toolbar select, .toolbar button, .toolbar a {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #2a2d35;
      background: rgba(20, 21, 26, 0.95);
      color: #e6edf3;
      font-size: 0.95rem;
      text-decoration: none;
    }
    .toolbar button { cursor: pointer; }
    .toolbar a { display: inline-block; }
    .toolbar .status { color: #8b9199; font-size: 0.85rem; }
    .nav-panel {
      position: fixed;
      bottom: 16px;
      left: 12px;
      right: 12px;
      z-index: 1000;
      padding: 14px;
      border-radius: 14px;
      background: rgba(20, 21, 26, 0.96);
      border: 1px solid #2a2d35;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .nav-panel .next-stop { font-size: 1rem; color: #e6edf3; }
    .nav-panel .btns { display: flex; gap: 10px; flex-wrap: wrap; }
    .nav-panel .btns a, .nav-panel .btns button {
      flex: 1;
      min-width: 120px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      border: none;
      cursor: pointer;
    }
    .nav-panel .btn-nav { background: #3b82f6; color: #fff; }
    .nav-panel .btn-arrived { background: #22c55e; color: #fff; }
    .nav-panel .all-done { color: #22c55e; font-size: 1.1rem; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toolbar">
    <select id="mapType">
      <option value="baidu">百度地图</option>
      <option value="osm">OpenStreetMap</option>
    </select>
    <button type="button" id="btnRefresh">更新路线</button>
    <a href="index.html" target="_self">← 返回控制台</a>
    <span id="routeInfo" class="status"></span>
  </div>

  <div id="navPanel" class="nav-panel" style="display: none;">
    <div id="nextStopText" class="next-stop"></div>
    <div class="btns">
      <a id="btnOpenNav" href="#" target="_blank" rel="noopener" class="btn-nav">打开导航</a>
      <button type="button" id="btnArrived" class="btn-arrived">已到达</button>
    </div>
  </div>
  <div id="allDonePanel" class="nav-panel" style="display: none;">
    <span class="all-done">✅ 全部送达</span>
    <a href="index.html" target="_self" class="btn-nav" style="text-align:center;">返回控制台</a>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
(function () {
  var STORAGE_API = "smartdiaodu_api_base";
  var STORAGE_DRIVER_LOC = "smartdiaodu_driver_loc";
  var STORAGE_PICKUPS = "smartdiaodu_pickups";
  var STORAGE_DELIVERIES = "smartdiaodu_deliveries";
  var STORAGE_SUPABASE_URL = "smartdiaodu_supabase_url";
  var STORAGE_SUPABASE_ANON = "smartdiaodu_supabase_anon_key";
  var STORAGE_DRIVER_ID = "smartdiaodu_driver_id";
  var STORAGE_MAP_STOP_INDEX = "smartdiaodu_map_stop_index";
  var STORAGE_MAP_ROUTE_HASH = "smartdiaodu_map_route_hash";
  var DEFAULT_DRIVER_ID = "a0000001-0000-4000-8000-000000000001";

  function getApiBase() {
    var v = (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_API)) || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.apiBase) || "";
    return (v || "").trim().replace(/\/$/, "");
  }
  function getSupabaseUrl() { return (typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_SUPABASE_URL) : "") || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.supabaseUrl) || ""; }
  function getSupabaseAnon() { return (typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_SUPABASE_ANON) : "") || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.supabaseAnonKey) || ""; }
  function getDriverId() {
    return (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_DRIVER_ID)) ||
      (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.driverId) || DEFAULT_DRIVER_ID;
  }
  function getSupabaseClient() {
    var url = getSupabaseUrl(), anon = getSupabaseAnon();
    if (!url || !anon || !window.supabase) return null;
    return window.supabase.createClient(url, anon);
  }
  function getBaiduMapAk() { return (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.baiduMapAk) || ""; }
  function getCurrentState() {
    var driver_loc = (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_DRIVER_LOC)) || "";
    var pickups = [], deliveries = [];
    try {
      var p = localStorage.getItem(STORAGE_PICKUPS), d = localStorage.getItem(STORAGE_DELIVERIES);
      if (p) pickups = JSON.parse(p);
      if (d) deliveries = JSON.parse(d);
    } catch (e) {}
    return { driver_loc: driver_loc || "如东县委党校", pickups: pickups, deliveries: deliveries };
  }

  var map = null, bmap = null, markers = [], routeLine = null, lastRouteData = null;
  var route_addresses = [], route_coords = [], point_types = [], point_labels = [];
  var currentStopIndex = 0;
  var mapTypeEl = document.getElementById("mapType");

  function wgs84ToBd09(lat, lng) {
    var x_PI = (3.14159265358979324 * 3000.0) / 180.0, a = 6378245.0, ee = 0.00669342162296594323;
    function trLat(x, y) {
      var r = -100 + 2 * x + 3 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
      r += (20 * Math.sin(6 * x * Math.PI) + 20 * Math.sin(2 * x * Math.PI)) * 2 / 3;
      r += (20 * Math.sin(y * Math.PI) + 40 * Math.sin(y / 3 * Math.PI)) * 2 / 3;
      return r;
    }
    function trLng(x, y) {
      var r = 300 + x + 2 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
      r += (20 * Math.sin(6 * x * Math.PI) + 20 * Math.sin(2 * x * Math.PI)) * 2 / 3;
      r += (20 * Math.sin(x * Math.PI) + 40 * Math.sin(x / 3 * Math.PI)) * 2 / 3;
      return r;
    }
    var dlat = trLat(lng - 105, lat - 35), dlng = trLng(lng - 105, lat - 35);
    var radlat = (lat / 180) * Math.PI, magic = 1 - ee * Math.sin(radlat) * Math.sin(radlat), sqrtmagic = Math.sqrt(magic);
    dlat = (dlat * 180) / ((a * (1 - ee)) / (magic * sqrtmagic) * Math.PI);
    dlng = (dlng * 180) / (a / sqrtmagic * Math.cos(radlat) * Math.PI);
    var mglat = lat + dlat, mglng = lng + dlng;
    return [mglng + 0.0065 * Math.cos(mglat * x_PI), mglat + 0.006 * Math.sin(mglng * x_PI)];
  }

  function getNavUrl(lat, lng, name) {
    var bd = wgs84ToBd09(lat, lng);
    var dest = bd[1] + "," + bd[0];
    return "baidumap://map/direction?destination=name:" + encodeURIComponent(name || "") + "|latlng:" + dest + "&mode=driving";
  }

  function getMapType() { return (mapTypeEl && mapTypeEl.value) || "osm"; }
  function destroyMap() {
    if (map) { map.remove(); map = null; }
    if (bmap) { try { bmap.destroy(); } catch (e) {} bmap = null; }
    markers = []; routeLine = null;
  }

  function initMap() {
    var useBaidu = getMapType() === "baidu";
    var ak = getBaiduMapAk();
    if (useBaidu && !ak) {
      document.getElementById("routeInfo").textContent = "未配置百度地图 AK，或选 OpenStreetMap";
      return;
    }
    destroyMap();
    if (useBaidu) {
      if (!window.BMap) {
        var script = document.createElement("script");
        script.src = "https://api.map.baidu.com/api?v=3.0&ak=" + ak + "&s=1";
        script.onload = function () { initBaiduMap(); if (lastRouteData) drawRouteFromIndex(currentStopIndex); };
        document.head.appendChild(script);
        return;
      }
      initBaiduMap();
      if (lastRouteData) drawRouteFromIndex(currentStopIndex);
      return;
    }
    map = L.map("map").setView([32.0, 121.0], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "© OSM" }).addTo(map);
    if (lastRouteData) drawRouteFromIndex(currentStopIndex);
  }

  function initBaiduMap() {
    if (bmap) return;
    bmap = new window.BMap.Map("map");
    bmap.centerAndZoom(new window.BMap.Point(121.0, 32.0), 10);
    bmap.enableScrollWheelZoom(true);
  }

  function clearMapOverlays() {
    if (map) { markers.forEach(function (m) { map.removeLayer(m); }); markers = []; if (routeLine) { map.removeLayer(routeLine); routeLine = null; } }
    if (bmap) bmap.clearOverlays();
  }

  var typeColor = { driver: "#3b82f6", pickup: "#22c55e", delivery: "#ef4444" };

  function drawRouteFromIndex(fromIndex) {
    if (!lastRouteData) return;
    var coords = route_coords.slice(fromIndex);
    var addresses = route_addresses.slice(fromIndex);
    var types = point_types.slice(fromIndex);
    var labels = point_labels.slice(fromIndex);
    document.getElementById("routeInfo").textContent = "剩余 " + (addresses.length - 1) + " 站";
    if (coords.length === 0) return;
    clearMapOverlays();
    var useBaidu = getMapType() === "baidu" && bmap;
    if (useBaidu) {
      var points = [];
      coords.forEach(function (c, i) {
        var bd = wgs84ToBd09(c[0], c[1]);
        points.push(new window.BMap.Point(bd[0], bd[1]));
        var mk = new window.BMap.Marker(new window.BMap.Point(bd[0], bd[1]));
        mk.setLabel(new window.BMap.Label((labels[i] || types[i] || "途经") + (addresses[i] ? " " + addresses[i].slice(0, 8) + "…" : ""), { offset: new window.BMap.Size(10, -10) }));
        bmap.addOverlay(mk);
      });
      bmap.addOverlay(new window.BMap.Polyline(points, { strokeColor: "#3b82f6", strokeWeight: 4 }));
      bmap.setViewport(points);
    } else if (map) {
      var latlngs = coords.map(function (c) { return [c[0], c[1]]; });
      routeLine = L.polyline(latlngs, { color: "#3b82f6", weight: 4 }).addTo(map);
      map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
      coords.forEach(function (c, i) {
        var color = typeColor[types[i]] || "#888";
        var m = L.circleMarker([c[0], c[1]], { radius: 10, fillColor: color, color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map);
        m.bindPopup(addresses[i] || "");
        markers.push(m);
      });
    }
  }

  function updateNavPanel() {
    var nextIdx = currentStopIndex + 1;
    var navPanel = document.getElementById("navPanel");
    var allDonePanel = document.getElementById("allDonePanel");
    if (nextIdx >= route_addresses.length) {
      navPanel.style.display = "none";
      allDonePanel.style.display = "block";
      return;
    }
    allDonePanel.style.display = "none";
    navPanel.style.display = "block";
    var label = point_labels[nextIdx] || point_types[nextIdx] || ("第" + (nextIdx + 1) + "站");
    var addr = route_addresses[nextIdx] || "";
    document.getElementById("nextStopText").textContent = "下一站: " + label + " " + (addr.length > 18 ? addr.slice(0, 18) + "…" : addr);
    var c = route_coords[nextIdx];
    if (c) {
      var a = document.getElementById("btnOpenNav");
      a.href = getNavUrl(c[0], c[1], addr);
      a.textContent = "打开导航（百度地图）";
    }
  }

  function saveStopIndex() {
    if (typeof localStorage !== "undefined") {
      localStorage.setItem(STORAGE_MAP_STOP_INDEX, String(currentStopIndex));
      localStorage.setItem(STORAGE_MAP_ROUTE_HASH, lastRouteData ? (route_addresses.join("|") || "") : "");
    }
  }

  function markArrived() {
    currentStopIndex++;
    var addr = route_addresses[currentStopIndex];
    var typ = point_types[currentStopIndex];
    if (addr && typeof localStorage !== "undefined") localStorage.setItem(STORAGE_DRIVER_LOC, addr);
    var sup = getSupabaseClient();
    if (sup) {
      sup.from("driver_state").update({ current_loc: addr || "" }).eq("driver_id", getDriverId()).then(function () {});
      if (typ === "delivery" && addr) {
        sup.from("order_pool").select("id").eq("delivery", addr).eq("assigned_driver_id", getDriverId()).eq("status", "assigned").limit(1)
          .then(function (r) {
            var row = r.data && r.data[0];
            if (row && row.id) {
              sup.from("order_pool").update({ status: "completed", assigned_driver_id: null }).eq("id", row.id).then(function () {});
              sup.from("driver_state").select("empty_seats").eq("driver_id", getDriverId()).maybeSingle().then(function (rr) {
                var next = (rr.data && rr.data.empty_seats != null) ? Math.min(4, rr.data.empty_seats + 1) : 1;
                sup.from("driver_state").update({ empty_seats: next }).eq("driver_id", getDriverId()).then(function () {});
              });
            }
          });
      }
    }
    saveStopIndex();
    drawRouteFromIndex(currentStopIndex);
    updateNavPanel();
  }

  document.getElementById("btnArrived").onclick = markArrived;

  function loadAndDraw() {
    var base = getApiBase();
    if (!base) {
      document.getElementById("routeInfo").textContent = "未配置后端（config.js apiBase）";
      return;
    }
    document.getElementById("routeInfo").textContent = "加载中…";
    var state = getCurrentState();
    fetch(base + "/current_route_preview", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ current_state: state })
    })
      .then(function (r) { if (!r.ok) return r.json().then(function (d) { throw new Error(d.detail || r.statusText); }); return r.json(); })
      .then(function (data) {
        route_addresses = data.route_addresses || [];
        route_coords = data.route_coords || [];
        point_types = data.point_types || [];
        point_labels = data.point_labels || [];
        lastRouteData = data;
        var hash = route_addresses.join("|");
        var savedHash = typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_MAP_ROUTE_HASH) : "";
        var savedIdx = typeof localStorage !== "undefined" ? parseInt(localStorage.getItem(STORAGE_MAP_STOP_INDEX), 10) : 0;
        currentStopIndex = (hash === savedHash && !isNaN(savedIdx)) ? Math.max(0, Math.min(savedIdx, route_addresses.length - 1)) : 0;
        saveStopIndex();
        initMap();
        drawRouteFromIndex(currentStopIndex);
        updateNavPanel();
        document.getElementById("routeInfo").textContent = "共 " + route_addresses.length + " 站，约 " + Math.round((data.total_time_seconds || 0) / 60) + " 分钟";
        if (bmap && typeof bmap.invalidateSize === "function") bmap.invalidateSize();
        if (map && typeof map.invalidateSize === "function") map.invalidateSize();
      })
      .catch(function (e) {
        document.getElementById("routeInfo").textContent = "失败：" + (e.message || e);
        clearMapOverlays();
        document.getElementById("navPanel").style.display = "none";
      });
  }

  document.getElementById("btnRefresh").onclick = function () {
    if (typeof localStorage !== "undefined") {
      localStorage.removeItem(STORAGE_MAP_STOP_INDEX);
      localStorage.removeItem(STORAGE_MAP_ROUTE_HASH);
    }
    currentStopIndex = 0;
    loadAndDraw();
  };
  if (mapTypeEl) mapTypeEl.addEventListener("change", function () { destroyMap(); initMap(); if (lastRouteData) drawRouteFromIndex(currentStopIndex); });

  loadAndDraw();
})();
  </script>
</body>
</html>

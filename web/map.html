<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0c0f" />
  <title>路线地图 · 全屏</title>
  <script src="config.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; min-height: 100vh; overflow: hidden; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; min-height: 300px; z-index: 0; background: #1a1a2e; }
    .toolbar {
      position: fixed;
      top: 12px;
      left: 12px;
      right: 12px;
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      pointer-events: none;
    }
    .toolbar > * { pointer-events: auto; }
    .toolbar .toolbar-label { padding: 10px 14px; font-size: 0.95rem; color: #e6edf3; }
    .toolbar select, .toolbar button, .toolbar a {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #2a2d35;
      background: rgba(20, 21, 26, 0.95);
      color: #e6edf3;
      font-size: 0.95rem;
      text-decoration: none;
    }
    .toolbar a.toolbar-nav { background: #3b82f6; color: #fff; border-color: #2563eb; }
    .toolbar button { cursor: pointer; }
    .toolbar a { display: inline-block; }
    .toolbar .status { color: #8b9199; font-size: 0.85rem; }
    .nav-panel {
      position: fixed;
      bottom: 16px;
      left: 12px;
      right: 12px;
      z-index: 1000;
      padding: 14px;
      border-radius: 14px;
      background: rgba(20, 21, 26, 0.96);
      border: 1px solid #2a2d35;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .nav-panel * { pointer-events: auto; }
    .nav-panel .next-stop { font-size: 1rem; color: #e6edf3; }
    .nav-panel .btns { display: flex; gap: 10px; flex-wrap: wrap; }
    .nav-panel .btns a, .nav-panel .btns button {
      flex: 1;
      min-width: 120px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      border: none;
      cursor: pointer;
    }
    .nav-panel .btn-nav { background: #3b82f6; color: #fff; }
    .nav-panel .btn-arrived { background: #22c55e; color: #fff; }
    .nav-panel .all-done { color: #22c55e; font-size: 1.1rem; }
    #btnToggleUI { position: fixed; top: 12px; right: 12px; z-index: 1001; padding: 10px 14px; border-radius: 10px; border: 1px solid #2a2d35; background: rgba(20,21,26,0.95); color: #e6edf3; font-size: 0.95rem; cursor: pointer; display: none; }
    #btnToggleUI.show { display: block; }
    body.toolbar-hidden .toolbar { display: none !important; }
    body.toolbar-hidden #navPanel { display: none !important; }
    body.toolbar-hidden #allDonePanel { display: none !important; }
    body.toolbar-hidden #routeStrategyPanel { display: none !important; }
    #routeStrategyPanel {
      position: fixed;
      top: 52px;
      left: 12px;
      z-index: 1002;
      padding: 12px;
      border-radius: 12px;
      background: rgba(20, 21, 26, 0.98);
      border: 1px solid #2a2d35;
      display: none;
      flex-direction: column;
      gap: 8px;
      min-width: 140px;
    }
    #routeStrategyPanel.show { display: flex; }
    #routeStrategyPanel button {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #2a2d35;
      background: rgba(40, 43, 53, 0.9);
      color: #e6edf3;
      font-size: 0.9rem;
      cursor: pointer;
      text-align: left;
    }
    #routeStrategyPanel button:hover { background: rgba(59, 130, 246, 0.3); }
    #routeStrategyPanel button.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.2); }
    /* 隐藏百度地图底部版权/署名栏 */
    #map .anchorBL,
    #map .BMap_cpyCtrl { display: none !important; }
    /* 起点/终点标注样式（与百度 App 一致：起=绿，终=红） */
    .route-label-qi { font-weight: 700; font-size: 14px; color: #fff !important; background: #22c55e !important; border: none; padding: 4px 10px; border-radius: 50%; min-width: 28px; text-align: center; }
    .route-label-zhong { font-weight: 700; font-size: 14px; color: #fff !important; background: #ef4444 !important; border: none; padding: 4px 10px; border-radius: 50%; min-width: 28px; text-align: center; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toolbar">
    <span class="toolbar-label">百度地图</span>
    <button type="button" id="btnRefresh">更新路线</button>
    <button type="button" id="btnRestore">恢复上次线路</button>
    <a href="index.html" target="_self">← 返回控制台</a>
    <a id="btnOpenNavToolbar" href="#" target="_blank" rel="noopener" class="toolbar-nav" style="display: none;">打开百度导航</a>
    <button type="button" id="btnStrategy" title="路线策略">路线策略</button>
    <span id="routeInfo" class="status"></span>
    <button type="button" id="btnCollapse" title="收起菜单">收起</button>
  </div>
  <div id="routeStrategyPanel" class="">
    <button type="button" data-policy="LEAST_TIME">用时最短</button>
    <button type="button" data-policy="LEAST_DISTANCE">距离最短</button>
    <button type="button" data-policy="LEAST_FEE">费用最省</button>
    <button type="button" data-policy="AVOID_CONGESTION">躲避拥堵</button>
    <button type="button" id="btnOtherRoute">其他线路</button>
  </div>
  <button type="button" id="btnToggleUI" title="显示菜单">≡ 菜单</button>
  <div id="navPanel" class="nav-panel" style="display: none;">
    <div id="nextStopText" class="next-stop"></div>
    <div class="btns">
      <a id="btnOpenNav" href="#" target="_blank" rel="noopener" class="btn-nav">打开导航</a>
      <button type="button" id="btnArrived" class="btn-arrived">已到达</button>
    </div>
  </div>
  <div id="allDonePanel" class="nav-panel" style="display: none;">
    <span class="all-done">✅ 全部送达</span>
    <a href="index.html" target="_self" class="btn-nav" style="text-align:center;">返回控制台</a>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
(function () {
  var STORAGE_API = "smartdiaodu_api_base";
  var STORAGE_DRIVER_LOC = "smartdiaodu_driver_loc";
  var STORAGE_PICKUPS = "smartdiaodu_pickups";
  var STORAGE_DELIVERIES = "smartdiaodu_deliveries";
  var STORAGE_SUPABASE_URL = "smartdiaodu_supabase_url";
  var STORAGE_SUPABASE_ANON = "smartdiaodu_supabase_anon_key";
  var STORAGE_DRIVER_ID = "smartdiaodu_driver_id";
  var STORAGE_MAP_STOP_INDEX = "smartdiaodu_map_stop_index";
  var STORAGE_MAP_ROUTE_HASH = "smartdiaodu_map_route_hash";
  var DEFAULT_DRIVER_ID = "a0000001-0000-4000-8000-000000000001";

  /** 除 Supabase URL/Anon 外，其余配置仅从数据库 app_config 读取 */
  var cachedAppConfig = { api_base: "", baidu_map_ak: "", driver_id: "" };
  function loadAppConfig(cb) {
    var sup = getSupabaseClient();
    if (!sup) { if (cb) cb(); return; }
    sup.from("app_config").select("key, value").then(function (r) {
      if (r.data && Array.isArray(r.data)) {
        r.data.forEach(function (row) {
          var k = row.key, v = (row.value || "").trim();
          if (k === "api_base") cachedAppConfig.api_base = v.replace(/\/$/, "");
          else if (k === "baidu_map_ak") cachedAppConfig.baidu_map_ak = v;
          else if (k === "driver_id") cachedAppConfig.driver_id = v;
        });
      }
      if (cb) cb();
    }).catch(function () { if (cb) cb(); });
  }
  function getApiBase() { return cachedAppConfig.api_base || ""; }
  function getSupabaseUrl() { return (typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_SUPABASE_URL) : "") || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.supabaseUrl) || ""; }
  function getSupabaseAnon() { return (typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_SUPABASE_ANON) : "") || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.supabaseAnonKey) || ""; }
  function getDriverId() { return cachedAppConfig.driver_id || DEFAULT_DRIVER_ID; }
  function getSupabaseClient() {
    var url = getSupabaseUrl(), anon = getSupabaseAnon();
    if (!url || !anon || !window.supabase) return null;
    return window.supabase.createClient(url, anon);
  }
  /** 地图底图仅从数据库 app_config 的 baidu_map_ak 读取 */
  function getBaiduMapAk() { return cachedAppConfig.baidu_map_ak || ""; }
  function getCurrentState() {
    var driver_loc = (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_DRIVER_LOC)) || "";
    var pickups = [], deliveries = [];
    try {
      var p = localStorage.getItem(STORAGE_PICKUPS), d = localStorage.getItem(STORAGE_DELIVERIES);
      if (p) pickups = JSON.parse(p);
      if (d) deliveries = JSON.parse(d);
    } catch (e) {}
    return { driver_loc: driver_loc || "如东县委党校", pickups: pickups, deliveries: deliveries };
  }

  /** 从数据库加载当前计划：司机位置 + 已分配订单的接/送地址，用于地图显示规划线路 */
  function loadStateFromSupabase(cb) {
    var sup = getSupabaseClient();
    if (!sup) { if (cb) cb(getCurrentState()); return; }
    var driverId = getDriverId();
    sup.from("driver_state").select("current_loc").eq("driver_id", driverId).maybeSingle()
      .then(function (r) {
        var driver_loc = (r.data && r.data.current_loc) ? String(r.data.current_loc).trim() : "";
        return sup.from("order_pool").select("pickup, delivery").eq("assigned_driver_id", driverId).eq("status", "assigned").order("id")
          .then(function (orders) {
            var pickups = [], deliveries = [];
            if (orders.data && Array.isArray(orders.data)) {
              orders.data.forEach(function (o) {
                pickups.push(o.pickup || "");
                deliveries.push(o.delivery || "");
              });
            }
            var state = {
              driver_loc: driver_loc || "如东县委党校",
              pickups: pickups,
              deliveries: deliveries
            };
            if (typeof localStorage !== "undefined") {
              localStorage.setItem(STORAGE_DRIVER_LOC, state.driver_loc);
              localStorage.setItem(STORAGE_PICKUPS, JSON.stringify(state.pickups));
              localStorage.setItem(STORAGE_DELIVERIES, JSON.stringify(state.deliveries));
            }
            if (cb) cb(state);
            return state;
          });
      })
      .catch(function () { if (cb) cb(getCurrentState()); });
  }

  var bmap = null, lastRouteData = null;
  var useBMapGL = false;
  var route_addresses = [], route_coords = [], point_types = [], point_labels = [];
  var route_path = [];
  var currentStopIndex = 0;
  var routePolicyKey = "LEAST_TIME";
  /** 分段算路时每段的结果（用于「其他线路」轮换）；切换策略或重新规划时清空 */
  var lastSegmentResults = [];
  /** 当前显示的备选线路索引（0=第一条，1=第二条…）；点「其他线路」时递增并重绘 */
  var routeAlternativeIndex = 0;

  /** 获取该段算路结果中的方案数量（getPlan(0), getPlan(1)...） */
  function getNumPlans(results) {
    if (!results || typeof results.getPlan !== "function") return 0;
    var n = 0;
    try { while (results.getPlan(n)) n++; } catch (e) {}
    return n;
  }

  /** 根据策略 key 返回 BMap.DrivingPolicy 常量（无则回退 LEAST_TIME） */
  function getDrivingPolicyValue(key) {
    var P = window.BMap && window.BMap.DrivingPolicy;
    if (!P) return undefined;
    var k = (key || routePolicyKey || "LEAST_TIME").toUpperCase();
    if (P[k] != null) return P[k];
    if (k === "LEAST_FEE" && P.LEAST_TOLL != null) return P.LEAST_TOLL;
    if (P.LEAST_TIME != null) return P.LEAST_TIME;
    return undefined;
  }

  function wgs84ToBd09(lat, lng) {
    var x_PI = (3.14159265358979324 * 3000.0) / 180.0, a = 6378245.0, ee = 0.00669342162296594323;
    function trLat(x, y) {
      var r = -100 + 2 * x + 3 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
      r += (20 * Math.sin(6 * x * Math.PI) + 20 * Math.sin(2 * x * Math.PI)) * 2 / 3;
      r += (20 * Math.sin(y * Math.PI) + 40 * Math.sin(y / 3 * Math.PI)) * 2 / 3;
      return r;
    }
    function trLng(x, y) {
      var r = 300 + x + 2 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
      r += (20 * Math.sin(6 * x * Math.PI) + 20 * Math.sin(2 * x * Math.PI)) * 2 / 3;
      r += (20 * Math.sin(x * Math.PI) + 40 * Math.sin(x / 3 * Math.PI)) * 2 / 3;
      return r;
    }
    var dlat = trLat(lng - 105, lat - 35), dlng = trLng(lng - 105, lat - 35);
    var radlat = (lat / 180) * Math.PI, magic = 1 - ee * Math.sin(radlat) * Math.sin(radlat), sqrtmagic = Math.sqrt(magic);
    dlat = (dlat * 180) / ((a * (1 - ee)) / (magic * sqrtmagic) * Math.PI);
    dlng = (dlng * 180) / (a / sqrtmagic * Math.cos(radlat) * Math.PI);
    var mglat = lat + dlat, mglng = lng + dlng;
    return [mglng + 0.0065 * Math.cos(mglat * x_PI), mglat + 0.006 * Math.sin(mglng * x_PI)];
  }

  /** 单点调起导航（仅终点，无途经点） */
  function getNavUrl(lat, lng, name) {
    var bd = wgs84ToBd09(lat, lng);
    if (!bd || bd[0] == null || bd[1] == null) return "#";
    var dest = bd[1] + "," + bd[0];
    return "baidumap://map/direction?destination=name:" + encodeURIComponent(name || "") + "|latlng:" + dest + "&mode=driving";
  }

  /**
   * 调起百度地图 App 导航（URL Scheme）
   * 格式要求：origin/destination 为 latlng:纬度,经度|name:名称；途经点用 viaPoints（JSON 且 URL 编码）
   * 按路线顺序：起点 → viaPoints → 终点，coord_type=bd09ll
   */
  function getNavUrlWithWaypoints() {
    if (!route_coords.length || route_addresses.length !== route_coords.length) return "#";
    var bd0 = wgs84ToBd09(route_coords[0][0], route_coords[0][1]);
    var bdLast = wgs84ToBd09(route_coords[route_coords.length - 1][0], route_coords[route_coords.length - 1][1]);
    if (!bd0 || bd0[0] == null || bd0[1] == null || !bdLast || bdLast[0] == null || bdLast[1] == null) return "#";
    var lat0 = bd0[1], lng0 = bd0[0];
    var latLast = bdLast[1], lngLast = bdLast[0];
    var origin = "latlng:" + lat0 + "," + lng0 + "|name:" + (point_labels[0] || "起点");
    var destination = "latlng:" + latLast + "," + lngLast + "|name:" + (point_labels[point_labels.length - 1] || "终点");
    var viaPointsList = [];
    for (var i = 1; i < route_coords.length - 1; i++) {
      var c = route_coords[i];
      if (!c || c[0] == null || c[1] == null) continue;
      var bd = wgs84ToBd09(c[0], c[1]);
      if (!bd || bd[0] == null || bd[1] == null) continue;
      viaPointsList.push({
        name: (point_labels[i] || ("第" + (i + 1) + "站")) + "",
        lat: bd[1],
        lng: bd[0]
      });
    }
    var viaData = { viaPoints: viaPointsList };
    var viaPointsStr = encodeURIComponent(JSON.stringify(viaData));
    var baiduUrl = "baidumap://map/direction?mode=driving&origin=" + encodeURIComponent(origin) + "&destination=" + encodeURIComponent(destination) + "&viaPoints=" + viaPointsStr + "&coord_type=bd09ll&src=smartdiaodu";
    return baiduUrl;
  }

  function destroyMap() {
    if (bmap) { try { bmap.destroy(); } catch (e) {} bmap = null; }
  }

  function initMap() {
    var ak = (getBaiduMapAk() || "").trim();
    if (!ak) {
      document.getElementById("routeInfo").textContent = "请在 app_config 中配置 baidu_map_ak（网页端 AK）";
      return;
    }
    destroyMap();
    useBMapGL = false;
    if (window.BMap && typeof window.BMap.Map === "function") {
      initBaiduMap();
      if (lastRouteData) drawRouteFromIndex(currentStopIndex);
      return;
    }
    window.baiduMapReady = function () {
      window.baiduMapReady = null;
      if (window.BMap && typeof window.BMap.Map === "function") {
        initBaiduMap();
        if (lastRouteData) drawRouteFromIndex(currentStopIndex);
        return;
      }
      document.getElementById("routeInfo").textContent = "百度地图 API 未就绪。请检查 F12 → Network 中 api.map.baidu.com 请求与 AK 白名单。";
    };
    var script = document.createElement("script");
    script.src = "https://api.map.baidu.com/api?v=3.0&ak=" + encodeURIComponent(ak) + "&s=1&callback=baiduMapReady";
    script.onerror = function () {
      document.getElementById("routeInfo").textContent = "百度地图脚本加载失败。请检查网络与 AK。";
    };
    document.head.appendChild(script);
  }

  function initBaiduMap() {
    if (bmap) return;
    var container = document.getElementById("map");
    if (!container) return;
    if (useBMapGL && window.BMapGL && typeof window.BMapGL.Map === "function") {
      bmap = new window.BMapGL.Map("map");
      bmap.centerAndZoom(new window.BMapGL.Point(121.18, 32.32), 10);
      bmap.enableScrollWheelZoom(true);
      if (typeof bmap.invalidateSize === "function") setTimeout(function () { bmap.invalidateSize(); }, 200);
      return;
    }
    if (window.BMap && typeof window.BMap.Map === "function") {
      bmap = new window.BMap.Map("map");
      bmap.centerAndZoom(new window.BMap.Point(121.0, 32.0), 10);
      bmap.enableScrollWheelZoom(true);
      if (typeof bmap.enableDragging === "function") bmap.enableDragging();
      if (typeof bmap.enableInertialDragging === "function") bmap.enableInertialDragging();
      if (typeof bmap.enableDoubleClickZoom === "function") bmap.enableDoubleClickZoom(true);
      if (typeof bmap.addEventListener === "function") {
        bmap.addEventListener("tilesloaded", function () { console.log("[地图] 瓦片已加载"); });
      }
      setTimeout(function () {
        if (bmap && typeof bmap.invalidateSize === "function") bmap.invalidateSize();
      }, 200);
    }
  }

  function clearMapOverlays() {
    if (bmap) {
      if (typeof bmap.clearOverlays === "function") bmap.clearOverlays();
      else if (typeof bmap.getOverlays === "function") {
        var list = bmap.getOverlays();
        if (list && list.length) for (var i = 0; i < list.length; i++) bmap.removeOverlay(list[i]);
      }
    }
  }

  /** 生成起点/终点圆形图标 data URL（与百度 App 一致：起=绿，终=红） */
  function getStartEndIconDataURL(text, bgColor) {
    var s = '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36"><circle cx="18" cy="18" r="16" fill="' + bgColor + '" stroke="#fff" stroke-width="2"/><text x="18" y="23" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold" font-family="sans-serif">' + text + '</text></svg>';
    return "data:image/svg+xml," + encodeURIComponent(s);
  }

  /** 途经点小圆标（仅数字）：乘客起点=蓝，乘客终点=黄 */
  function getViaPointIconDataURL(num, isDelivery) {
    var bg = isDelivery ? "#eab308" : "#3b82f6";
    var s = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28"><circle cx="14" cy="14" r="12" fill="' + bg + '" stroke="#fff" stroke-width="2"/><text x="14" y="18" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold" font-family="sans-serif">' + num + '</text></svg>';
    return "data:image/svg+xml," + encodeURIComponent(s);
  }

  /** 添加起/终/途经点标注：途经点默认只显示序号，点击显示详情；乘客起点蓝、乘客终点黄 */
  function addMarkersWithNS(bdPoints, fromIndex, addresses, labels, types, NS) {
    var orderNums = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
    for (var i = 0; i < bdPoints.length; i++) {
      var pt = bdPoints[i];
      var num = fromIndex + i + 1;
      var numStr = orderNums[num - 1] || String(num);
      var typeLabel = (labels && labels[i]) || (types && types[i]) || "途经";
      var fullAddr = (addresses && addresses[i]) ? String(addresses[i]) : "";
      var mk;
      if (i === 0) {
        mk = new NS.Marker(pt, { icon: new NS.Icon(getStartEndIconDataURL("起", "#22c55e"), new NS.Size(36, 36)) });
      } else if (i === bdPoints.length - 1) {
        mk = new NS.Marker(pt, { icon: new NS.Icon(getStartEndIconDataURL("终", "#ef4444"), new NS.Size(36, 36)) });
      } else {
        var isDelivery = (types && types[i] === "delivery");
        mk = new NS.Marker(pt, { icon: new NS.Icon(getViaPointIconDataURL(numStr, isDelivery), new NS.Size(28, 28)) });
        if (typeof NS.InfoWindow !== "undefined" && bmap) {
          var detail = typeLabel + (fullAddr ? "<br/>" + fullAddr.replace(/</g, "&lt;") : "");
          (function (marker, content) {
            marker.addEventListener("click", function () {
              var info = new NS.InfoWindow(content, { width: 260, enableMessage: false });
              bmap.openInfoWindow(info, marker.getPosition());
            });
          })(mk, detail);
        }
      }
      bmap.addOverlay(mk);
    }
  }

  var ROUTE_STROKE_WEIGHT = 12;
  var ROUTE_GREEN = "#18a45b";
  /** 备选线路颜色（浅灰绿，与主线路绿色区分） */
  var ROUTE_ALTERNATIVE_COLOR = "#7cb89a";

  /** 按比例截取路径中段（起点/终点/途经点附近不画箭头，只在中段显示） */
  function pathSegmentForArrows(pathBd, startFrac, endFrac) {
    if (!pathBd || pathBd.length < 2 || startFrac >= endFrac) return pathBd;
    var BPoint = window.BMap && window.BMap.Point;
    if (!BPoint) return pathBd;
    function dist(p1, p2) {
      var dx = (p2.lng - p1.lng) * 111320 * Math.cos((p1.lat || 0) * Math.PI / 180);
      var dy = (p2.lat - p1.lat) * 110540;
      return Math.sqrt(dx * dx + dy * dy);
    }
    function interp(p1, p2, t) {
      return new BPoint(p1.lng + t * (p2.lng - p1.lng), p1.lat + t * (p2.lat - p1.lat));
    }
    var total = 0, segs = [];
    for (var i = 0; i < pathBd.length - 1; i++) {
      var d = dist(pathBd[i], pathBd[i + 1]);
      segs.push({ start: pathBd[i], end: pathBd[i + 1], len: d });
      total += d;
    }
    if (total <= 0) return pathBd;
    var startLen = startFrac * total, endLen = endFrac * total, acc = 0, out = [];
    for (var j = 0; j < segs.length; j++) {
      var seg = segs[j], segStart = acc, segEnd = acc + seg.len;
      acc = segEnd;
      if (segEnd <= startLen || segStart >= endLen) continue;
      var t0 = segStart < startLen ? (startLen - segStart) / seg.len : 0;
      var t1 = segEnd > endLen ? (endLen - segStart) / seg.len : 1;
      if (t0 > 0) out.push(interp(seg.start, seg.end, t0));
      if (t1 > t0 && t1 < 1) out.push(interp(seg.start, seg.end, t1));
      else if (t1 >= 1) out.push(seg.end);
    }
    return out.length >= 2 ? out : pathBd;
  }

  /** 在 path 上绘制带方向箭头的折线；箭头只画在路线中段（约 3%～97%），不覆盖起点/终点/途经点 */
  function addDirectionalPolyline(pathBd, strokeColor) {
    if (useBMapGL) return;
    strokeColor = strokeColor || ROUTE_GREEN;
    try {
      var SymbolShape = window.BMap_Symbol_SHAPE_FORWARD_CLOSED_ARROW || window.BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW;
      if (window.BMap.Symbol && window.BMap.IconSequence && SymbolShape != null) {
        var sy = new window.BMap.Symbol(SymbolShape, { scale: 1.0, strokeColor: "#ffffff", fillColor: "#ffffff", strokeWeight: 0 });
        var icons = new window.BMap.IconSequence(sy, "100%", "0.15%");
        var lineFull = new window.BMap.Polyline(pathBd, { strokeColor: strokeColor, strokeWeight: ROUTE_STROKE_WEIGHT, strokeOpacity: 0.95 });
        bmap.addOverlay(lineFull);
        var midPath = pathSegmentForArrows(pathBd, 0.03, 0.97);
        if (midPath.length >= 2) {
          var lineArrows = new window.BMap.Polyline(midPath, { strokeColor: "transparent", strokeWeight: ROUTE_STROKE_WEIGHT, strokeOpacity: 0, icons: [icons] });
          bmap.addOverlay(lineArrows);
        }
        return;
      }
    } catch (e) {}
    bmap.addOverlay(new window.BMap.Polyline(pathBd, { strokeColor: strokeColor, strokeWeight: ROUTE_STROKE_WEIGHT, strokeOpacity: 0.95 }));
  }

  /** 在路线段上标注道路名称（很大的路：高速、国道、大道等），大号黑字贴路线 */
  function addRoadNameLabels(route) {
    if (!bmap || !route || typeof route.getNumSteps !== "function") return;
    try {
      var n = route.getNumSteps();
      for (var i = 0; i < n; i++) {
        var step = route.getStep && route.getStep(i);
        if (!step) continue;
        var name = (step.getRoadName && step.getRoadName()) || (step.roadName) || "";
        if (!name || name === "无名路" || name.length > 20) continue;
        if (!/高速|国道|省道|大道|快速路|环路|线|路$/.test(name)) continue;
        var path = step.getPath && step.getPath();
        if (!path || path.length === 0) continue;
        var mid = path[Math.floor(path.length / 2)];
        if (!mid) continue;
        var label = new window.BMap.Label(name, {
          offset: new window.BMap.Size(0, 0),
          position: mid,
          enableMassClear: true
        });
        label.setStyle({
          color: "#1a1a1a",
          fontSize: "18px",
          fontWeight: "bold",
          border: "none",
          backgroundColor: "transparent",
          padding: "0"
        });
        bmap.addOverlay(label);
      }
    } catch (e) {}
  }

  /** 按实际驾车道路绘制路线：BMapGL 用 DrivingRoute 一次规划贴合道路，BMap 用 route_path 或分段规划 */
  function drawRouteFromIndex(fromIndex) {
    if (!lastRouteData) return;
    var coords = route_coords.slice(fromIndex);
    var addresses = route_addresses.slice(fromIndex);
    var types = point_types.slice(fromIndex);
    var labels = point_labels.slice(fromIndex);
    document.getElementById("routeInfo").textContent = "剩余 " + (addresses.length - 1) + " 站";
    if (coords.length === 0) return;
    clearMapOverlays();
    if (!bmap) return;
    var NS = useBMapGL ? window.BMapGL : window.BMap;
    if (!NS || !NS.Point) return;
    var bdPoints = [];
    for (var i = 0; i < coords.length; i++) {
      var c = coords[i];
      if (!c || c[0] == null || c[1] == null) continue;
      var bd = wgs84ToBd09(c[0], c[1]);
      if (!bd || bd[0] == null || bd[1] == null) continue;
      bdPoints.push(new NS.Point(bd[0], bd[1]));
    }
    if (bdPoints.length === 0) return;
    if (bdPoints.length === 1) {
      bmap.setCenter && bmap.setCenter(bdPoints[0]);
      bmap.setZoom && bmap.setZoom(14);
      addMarkersWithNS(bdPoints, fromIndex, addresses, labels, types, NS);
      return;
    }
    if (useBMapGL && window.BMapGL && window.BMapGL.DrivingRoute) {
      var driving = new window.BMapGL.DrivingRoute(bmap, {
        renderOptions: { map: bmap, autoViewport: true }
      });
      var start = bdPoints[0], end = bdPoints[bdPoints.length - 1];
      var waypoints = bdPoints.length > 2 ? bdPoints.slice(1, -1).slice(0, 10) : [];
      document.getElementById("routeInfo").textContent = "正在规划驾车路线…";
      driving.search(start, end, waypoints.length ? { waypoints: waypoints } : undefined);
      var onDone = function () {
        addMarkersWithNS(bdPoints, fromIndex, addresses, labels, types, NS);
        document.getElementById("routeInfo").textContent = "剩余 " + (addresses.length - 1) + " 站";
      };
      if (typeof driving.setSearchCompleteCallback === "function") {
        driving.setSearchCompleteCallback(onDone);
      } else {
        setTimeout(onDone, 1500);
      }
      return;
    }
    addMarkersWithNS(bdPoints, fromIndex, addresses, labels, types, NS);
    if (typeof window.BMap.DrivingRoute === "undefined") {
      addDirectionalPolyline(bdPoints, ROUTE_GREEN);
      if (bmap.setViewport) bmap.setViewport(bdPoints);
      return;
    }
    var opts = {
      renderOptions: { map: null },
      policy: getDrivingPolicyValue(routePolicyKey)
    };
    lastSegmentResults = [];
    routeAlternativeIndex = 0;
    var driving = new window.BMap.DrivingRoute(bmap, opts);
    var segIndex = 0;
    function updateStatus() {
      document.getElementById("routeInfo").textContent = "剩余 " + (addresses.length - 1) + " 站";
    }
    function searchNextSegment() {
      if (segIndex >= bdPoints.length - 1) {
        if (bmap.setViewport) bmap.setViewport(bdPoints);
        updateStatus();
        updateNavPanel();
        return;
      }
      driving.search(bdPoints[segIndex], bdPoints[segIndex + 1]);
    }
    var onSegmentFail = function () {
      bmap.addOverlay(new window.BMap.Polyline([bdPoints[segIndex], bdPoints[segIndex + 1]], { strokeColor: ROUTE_GREEN, strokeWeight: ROUTE_STROKE_WEIGHT }));
      segIndex++;
      searchNextSegment();
    };
    if (typeof driving.setSearchCompleteCallback === "function") {
      driving.setSearchCompleteCallback(function () {
        var results = driving.getResults && driving.getResults();
        if (results) {
          lastSegmentResults[segIndex] = results;
          var nPlans = getNumPlans(results);
          var planIdx = nPlans ? (routeAlternativeIndex % nPlans) : 0;
          var plan = results.getPlan && results.getPlan(planIdx);
          if (!plan) plan = results.getPlan && results.getPlan(0);
          if (plan) {
            try {
              var route = plan.getRoute && plan.getRoute(0);
              var path = route && route.getPath && route.getPath();
              if (path && path.length > 0) {
                addDirectionalPolyline(path, ROUTE_GREEN);
                addRoadNameLabels(route);
                segIndex++;
                searchNextSegment();
                return;
              }
            } catch (e) {}
          }
        }
        onSegmentFail();
      });
    }
    if (typeof driving.setErrorCallback === "function") {
      driving.setErrorCallback(onSegmentFail);
    }
    document.getElementById("routeInfo").textContent = "正在规划驾车路线…";
    searchNextSegment();
  }

  /** 用已保存的分段结果重绘路线，显示第 routeAlternativeIndex 条备选方案（由「其他线路」调用） */
  function redrawFromStoredSegments() {
    if (!bmap || !lastRouteData || !lastSegmentResults || lastSegmentResults.length === 0) return;
    var fromIndex = currentStopIndex;
    var coords = route_coords.slice(fromIndex);
    var addresses = route_addresses.slice(fromIndex);
    var types = point_types.slice(fromIndex);
    var labels = point_labels.slice(fromIndex);
    var NS = useBMapGL ? window.BMapGL : window.BMap;
    if (!NS || !NS.Point) return;
    var bdPoints = [];
    for (var i = 0; i < coords.length; i++) {
      var c = coords[i];
      if (!c || c[0] == null || c[1] == null) continue;
      var bd = wgs84ToBd09(c[0], c[1]);
      if (!bd || bd[0] == null || bd[1] == null) continue;
      bdPoints.push(new NS.Point(bd[0], bd[1]));
    }
    if (bdPoints.length < 2) return;
    clearMapOverlays();
    addMarkersWithNS(bdPoints, fromIndex, addresses, labels, types, NS);
    for (var i = 0; i < lastSegmentResults.length; i++) {
      var res = lastSegmentResults[i];
      if (!res) continue;
      var nPlans = getNumPlans(res);
      var planIdx = nPlans ? (routeAlternativeIndex % nPlans) : 0;
      var plan = res.getPlan && res.getPlan(planIdx);
      if (!plan) plan = res.getPlan && res.getPlan(0);
      if (!plan) continue;
      try {
        var route = plan.getRoute && plan.getRoute(0);
        var path = route && route.getPath && route.getPath();
        if (path && path.length > 0) {
          addDirectionalPolyline(path, ROUTE_ALTERNATIVE_COLOR);
          addRoadNameLabels(route);
        }
      } catch (e) {}
    }
    if (bmap.setViewport) bmap.setViewport(bdPoints);
    updateNavPanel();
    var totalPlans = getNumPlans(lastSegmentResults[0] || {});
    var tip = totalPlans > 1
      ? "已切换为第 " + (routeAlternativeIndex % totalPlans + 1) + " 条备选线路（共 " + totalPlans + " 条）"
      : "当前仅有一条线路";
    document.getElementById("routeInfo").textContent = tip;
  }

  function updateNavPanel() {
    var nextIdx = currentStopIndex + 1;
    var navPanel = document.getElementById("navPanel");
    var allDonePanel = document.getElementById("allDonePanel");
    var navUrl = (route_addresses.length >= 2) ? getNavUrlWithWaypoints() : "#";
    var toolbarNav = document.getElementById("btnOpenNavToolbar");
    if (toolbarNav) {
      toolbarNav.href = navUrl;
      toolbarNav.style.display = (route_addresses.length >= 2 && navUrl !== "#") ? "" : "none";
    }
    if (nextIdx >= route_addresses.length) {
      navPanel.style.display = "none";
      allDonePanel.style.display = "block";
      return;
    }
    allDonePanel.style.display = "none";
    navPanel.style.display = "block";
    var label = point_labels[nextIdx] || point_types[nextIdx] || ("第" + (nextIdx + 1) + "站");
    var addr = route_addresses[nextIdx] || "";
    document.getElementById("nextStopText").textContent = "下一站: " + label + " " + (addr.length > 18 ? addr.slice(0, 18) + "…" : addr);
    var a = document.getElementById("btnOpenNav");
    a.href = navUrl;
    a.textContent = "打开导航（百度地图，含途经点）";
  }

  function saveStopIndex() {
    if (typeof localStorage !== "undefined") {
      localStorage.setItem(STORAGE_MAP_STOP_INDEX, String(currentStopIndex));
      localStorage.setItem(STORAGE_MAP_ROUTE_HASH, lastRouteData ? (route_addresses.join("|") || "") : "");
    }
  }

  /** 将接口或快照数据应用到全局并画图 */
  function applyRouteData(data) {
    route_addresses = data.route_addresses || [];
    route_coords = data.route_coords || [];
    point_types = data.point_types || [];
    point_labels = data.point_labels || [];
    route_path = Array.isArray(data.route_path) ? data.route_path : [];
    lastRouteData = data;
    var hash = route_addresses.join("|");
    var savedHash = typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_MAP_ROUTE_HASH) : "";
    var savedIdx = typeof localStorage !== "undefined" ? parseInt(localStorage.getItem(STORAGE_MAP_STOP_INDEX), 10) : 0;
    currentStopIndex = (hash === savedHash && !isNaN(savedIdx)) ? Math.max(0, Math.min(savedIdx, route_addresses.length - 1)) : 0;
    saveStopIndex();
    initMap();
    drawRouteFromIndex(currentStopIndex);
    updateNavPanel();
    if (bmap && typeof bmap.invalidateSize === "function") bmap.invalidateSize();
  }

  /** 规划结果入库（每司机一条，覆盖） */
  function saveRouteSnapshot(data) {
    var sup = getSupabaseClient();
    if (!sup || !data || !(data.route_addresses && data.route_addresses.length)) return;
    var payload = {
      driver_id: getDriverId(),
      route_addresses: data.route_addresses,
      route_coords: data.route_coords || [],
      point_types: data.point_types || [],
      point_labels: data.point_labels || [],
      total_time_seconds: Math.max(0, parseInt(data.total_time_seconds, 10) || 0)
    };
    sup.from("driver_route_snapshot").upsert(payload, { onConflict: "driver_id" }).then(function () {});
  }

  /** 从数据库读取上次保存的线路快照 */
  function loadSavedRoute(cb) {
    var sup = getSupabaseClient();
    if (!sup) { if (cb) cb(null); return; }
    sup.from("driver_route_snapshot").select("route_addresses, route_coords, point_types, point_labels, total_time_seconds")
      .eq("driver_id", getDriverId()).maybeSingle()
      .then(function (r) {
        var d = r.data;
        if (d && Array.isArray(d.route_addresses) && d.route_addresses.length > 0 && Array.isArray(d.route_coords) && d.route_coords.length > 0) {
          if (cb) cb({
            route_addresses: d.route_addresses,
            route_coords: d.route_coords,
            point_types: Array.isArray(d.point_types) ? d.point_types : [],
            point_labels: Array.isArray(d.point_labels) ? d.point_labels : [],
            total_time_seconds: d.total_time_seconds || 0
          });
        } else {
          if (cb) cb(null);
        }
      })
      .catch(function () { if (cb) cb(null); });
  }

  function markArrived() {
    currentStopIndex++;
    var addr = route_addresses[currentStopIndex];
    var typ = point_types[currentStopIndex];
    if (addr && typeof localStorage !== "undefined") localStorage.setItem(STORAGE_DRIVER_LOC, addr);
    var sup = getSupabaseClient();
    if (sup) {
      sup.from("driver_state").update({ current_loc: addr || "" }).eq("driver_id", getDriverId()).then(function () {});
      if (typ === "delivery" && addr) {
        sup.from("order_pool").select("id").eq("delivery", addr).eq("assigned_driver_id", getDriverId()).eq("status", "assigned").limit(1)
          .then(function (r) {
            var row = r.data && r.data[0];
            if (row && row.id) {
              sup.from("order_pool").update({ status: "completed", assigned_driver_id: null }).eq("id", row.id).then(function () {});
              sup.from("driver_state").select("empty_seats").eq("driver_id", getDriverId()).maybeSingle().then(function (rr) {
                var next = (rr.data && rr.data.empty_seats != null) ? Math.min(4, rr.data.empty_seats + 1) : 1;
                sup.from("driver_state").update({ empty_seats: next }).eq("driver_id", getDriverId()).then(function () {});
              });
            }
          });
      }
    }
    saveStopIndex();
    drawRouteFromIndex(currentStopIndex);
    updateNavPanel();
  }

  document.getElementById("btnArrived").onclick = markArrived;

  document.getElementById("btnCollapse").onclick = function () {
    document.body.classList.add("toolbar-hidden");
    document.getElementById("btnToggleUI").classList.add("show");
    document.getElementById("routeStrategyPanel").classList.remove("show");
  };
  document.getElementById("btnToggleUI").onclick = function () {
    document.body.classList.remove("toolbar-hidden");
    document.getElementById("btnToggleUI").classList.remove("show");
    document.getElementById("routeStrategyPanel").classList.remove("show");
    updateNavPanel();
  };

  function updateStrategyPanelActive() {
    var panel = document.getElementById("routeStrategyPanel");
    if (!panel) return;
    var btns = panel.querySelectorAll("button[data-policy]");
    for (var i = 0; i < btns.length; i++) {
      btns[i].classList.toggle("active", (btns[i].getAttribute("data-policy") || "").toUpperCase() === (routePolicyKey || "LEAST_TIME").toUpperCase());
    }
  }

  document.getElementById("btnStrategy").onclick = function (e) {
    e.stopPropagation();
    var panel = document.getElementById("routeStrategyPanel");
    panel.classList.toggle("show");
    updateStrategyPanelActive();
  };

  (function () {
    var strategyBtns = document.getElementById("routeStrategyPanel").querySelectorAll("button[data-policy]");
    for (var i = 0; i < strategyBtns.length; i++) {
      (function (btn) {
        btn.onclick = function () {
          var key = (btn.getAttribute("data-policy") || "LEAST_TIME").toUpperCase();
          routePolicyKey = key;
          document.getElementById("routeStrategyPanel").classList.remove("show");
          updateStrategyPanelActive();
          if (lastRouteData && bmap) {
            document.getElementById("routeInfo").textContent = "正在按「" + (btn.textContent || key) + "」重新规划…";
            drawRouteFromIndex(currentStopIndex);
            updateNavPanel();
          }
        };
      })(strategyBtns[i]);
    }
    var btnOther = document.getElementById("btnOtherRoute");
    if (btnOther) {
      btnOther.onclick = function () {
        if (!lastSegmentResults || lastSegmentResults.length === 0) {
          document.getElementById("routeInfo").textContent = "请先规划路线后再切换其他线路";
          return;
        }
        routeAlternativeIndex++;
        redrawFromStoredSegments();
        document.getElementById("routeStrategyPanel").classList.remove("show");
      };
    }
  })();

  document.addEventListener("click", function () {
    document.getElementById("routeStrategyPanel").classList.remove("show");
  });
  document.getElementById("routeStrategyPanel").addEventListener("click", function (e) {
    e.stopPropagation();
  });

  function loadAndDraw() {
    var base = getApiBase();
    var statusEl = document.getElementById("routeInfo");
    if (!base) {
      initMap();
      loadSavedRoute(function (data) {
        if (data) {
          applyRouteData(data);
          statusEl.textContent = "已恢复上次线路（共 " + route_addresses.length + " 站）；未配置 apiBase 无法重新规划";
        } else {
          statusEl.textContent = "未配置后端（请在 Supabase 表 app_config 中设置 key=api_base）";
        }
      });
      return;
    }
    statusEl.textContent = "从数据库加载计划…";
    loadStateFromSupabase(function (state) {
      statusEl.textContent = "规划路线中…";
      fetch(base + "/current_route_preview", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ current_state: state })
      })
      .then(function (r) { if (!r.ok) return r.json().then(function (d) { throw new Error(d.detail || r.statusText); }); return r.json(); })
      .then(function (data) {
        applyRouteData(data);
        saveRouteSnapshot(data);
        document.getElementById("routeInfo").textContent = "共 " + route_addresses.length + " 站，约 " + Math.round((data.total_time_seconds || 0) / 60) + " 分钟（已入库）";
      })
      .catch(function (e) {
        document.getElementById("navPanel").style.display = "none";
        initMap();
        var msg = e.message || String(e);
        var hint = "";
        if (/failed to fetch|networkerror|load failed/i.test(msg) && window.location.protocol === "https:") {
          hint = "（HTTPS 页面请求 HTTP 后端可能被浏览器拦截，请将后端改为 HTTPS 或在本机用 HTTP 打开页面）";
        } else if (/地址无法解析|地理编码|地址.*解析/i.test(msg)) {
          hint = "。请到控制台修改「我的位置」或乘客起终点为更详细地址（如带区县、街道）后重试「更新路线」";
        }
        document.getElementById("routeInfo").textContent = "路线加载失败：" + msg + hint + "，仅显示地图";
      });
    });
  }

  document.getElementById("btnRefresh").onclick = function () {
    if (typeof localStorage !== "undefined") {
      localStorage.removeItem(STORAGE_MAP_STOP_INDEX);
      localStorage.removeItem(STORAGE_MAP_ROUTE_HASH);
    }
    currentStopIndex = 0;
    loadAndDraw();
  };

  document.getElementById("btnRestore").onclick = function () {
    var statusEl = document.getElementById("routeInfo");
    statusEl.textContent = "加载中…";
    loadSavedRoute(function (data) {
      if (data) {
        applyRouteData(data);
        statusEl.textContent = "已恢复上次线路（共 " + route_addresses.length + " 站，约 " + Math.round((data.total_time_seconds || 0) / 60) + " 分钟）";
      } else {
        statusEl.textContent = "无已保存线路，请先点「更新路线」规划并入库";
        if (bmap) clearMapOverlays();
      }
    });
  };

  // 进入页面：先从数据库加载 app_config，再初始化地图与路线
  (function onLoad() {
    var statusEl = document.getElementById("routeInfo");
    statusEl.textContent = "加载配置…";
    loadAppConfig(function () {
      statusEl.textContent = "加载中…";
      initMap();
      loadSavedRoute(function (data) {
        if (data) {
          applyRouteData(data);
          statusEl.textContent = "已恢复上次线路（共 " + route_addresses.length + " 站，约 " + Math.round((data.total_time_seconds || 0) / 60) + " 分钟）";
        } else {
          loadAndDraw();
        }
      });
    });
  })();
})();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>登录 · 顺风车智能调度</title>
  <script src="config.js"></script>
  <style>
    :root { --bg: #0f1419; --card: #1a2332; --border: #2d3a4d; --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff; --red: #f85149; }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", "PingFang SC", sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; max-width: 360px; width: 100%; }
    h1 { font-size: 1.25rem; margin: 0 0 0.5rem 0; }
    .subtitle { color: var(--muted); font-size: 0.85rem; margin-bottom: 1.5rem; }
    label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.25rem; }
    input[type="text"], input[type="password"], input[type="url"], input[type="email"] { width: 100%; padding: 0.6rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem; margin-bottom: 1rem; }
    input:focus { outline: none; border-color: var(--accent); }
    .btn { width: 100%; padding: 0.75rem; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; background: var(--accent); color: #fff; margin-top: 0.5rem; }
    .btn:hover { filter: brightness(1.1); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .err { color: var(--red); font-size: 0.9rem; margin-top: 0.75rem; display: none; }
    .hint { font-size: 0.8rem; color: var(--muted); margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>顺风车智能调度</h1>
    <p class="subtitle">网页直连 Supabase 登录（HTTPS，无需自建后端）</p>
    <form id="loginForm">
      <label>邮箱</label>
      <input type="email" id="email" placeholder="admin@test.com" autocomplete="username" />
      <label>密码</label>
      <input type="password" id="password" placeholder="密码" autocomplete="current-password" />
      <button type="submit" class="btn" id="btnSubmit">登录</button>
      <p id="err" class="err"></p>
    </form>
    <p class="hint">Supabase URL 与密钥从 config（环境变量）自动读取；请在 Supabase 控制台添加用户（邮箱+密码）。</p>
  </div>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
(function () {
  var STORAGE_API = "smartdiaodu_api_base";
  var STORAGE_TOKEN = "smartdiaodu_token";
  var STORAGE_USERNAME = "smartdiaodu_username";
  var STORAGE_SUPABASE_URL = "smartdiaodu_supabase_url";
  var STORAGE_SUPABASE_ANON = "smartdiaodu_supabase_anon_key";
  var form = document.getElementById("loginForm");
  var emailInput = document.getElementById("email");
  var passwordInput = document.getElementById("password");
  var btnSubmit = document.getElementById("btnSubmit");
  var errEl = document.getElementById("err");

  var cfg = typeof window.SMARTDIAODU_CONFIG !== "undefined" ? window.SMARTDIAODU_CONFIG : {};
  function getSupabaseUrl() {
    return (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_SUPABASE_URL)) || cfg.supabaseUrl || "";
  }
  function getSupabaseAnon() {
    return (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_SUPABASE_ANON)) || cfg.supabaseAnonKey || "";
  }

  function showErr(msg) {
    errEl.textContent = msg || "";
    errEl.style.display = msg ? "block" : "none";
  }

  form.addEventListener("submit", function (e) {
    e.preventDefault();
    try {
    var url = getSupabaseUrl().trim();
    var anon = getSupabaseAnon().trim();
    var email = (emailInput.value || "").trim();
    var password = passwordInput.value || "";
    showErr("");
    if (!url) { showErr("未配置 Supabase URL，请在 Cloudflare 环境变量或 config.js 中设置 SUPABASE_URL"); return; }
    if (!anon) { showErr("未配置 Supabase Anon Key，请在 Cloudflare 环境变量或 config.js 中设置 SUPABASE_ANON_KEY"); return; }
    if (!email) { showErr("请填写邮箱"); return; }
    if (!password) { showErr("请填写密码"); return; }
    if (!window.supabase || typeof window.supabase.createClient !== "function") {
      showErr("Supabase 脚本未加载成功，请检查网络或稍后重试"); return;
    }
    btnSubmit.disabled = true;
    var supabase = window.supabase.createClient(url, anon);
    supabase.auth.signInWithPassword({ email: email, password: password })
      .then(function (r) {
        if (r.error) throw new Error(r.error.message || "登录失败");
        if (typeof localStorage !== "undefined") {
          localStorage.setItem(STORAGE_SUPABASE_URL, url);
          localStorage.setItem(STORAGE_SUPABASE_ANON, anon);
          var tok = (r.data.session && r.data.session.access_token) ? r.data.session.access_token : "1";
          localStorage.setItem(STORAGE_TOKEN, tok);
          if (r.data.user && r.data.user.email) localStorage.setItem(STORAGE_USERNAME, r.data.user.email);
          if (cfg.apiBase) localStorage.setItem(STORAGE_API, cfg.apiBase);
          if (cfg.driverId) localStorage.setItem("smartdiaodu_driver_id", cfg.driverId);
        }
        window.location.href = "index.html";
      })
      .catch(function (e) {
        showErr(e.message || "网络错误");
        btnSubmit.disabled = false;
      });
    } catch (err) {
      showErr(err && err.message ? err.message : "登录出错，请重试");
      btnSubmit.disabled = false;
    }
  });
})();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0c0f" />
  <title>é¡ºé£è½¦è°ƒåº¦ Â· æ§åˆ¶å°</title>
  <script src="config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            panel: '#14151a',
            border: '#2a2d35',
            muted: '#8b9199',
            accent: '#3b82f6',
            success: '#22c55e',
            danger: '#ef4444',
          },
          fontSize: {
            'console': ['1.125rem', { lineHeight: '1.5' }],
            'big': ['1.35rem', { lineHeight: '1.4' }],
            'hero': ['1.6rem', { lineHeight: '1.3' }],
          },
        },
      },
    };
  </script>
  <style>
    body { -webkit-tap-highlight-color: transparent; }
    .btn-touch { min-height: 48px; min-width: 48px; }
    input, select, button { font-size: inherit; }
  </style>
</head>
<body class="bg-[#0c0c0f] text-gray-100 min-h-screen font-sans antialiased pb-8">
  <div class="max-w-lg mx-auto px-4 pt-4">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-success animate-pulse" aria-hidden="true"></span>
        <span class="text-console text-muted">AI å¤§è„‘åœ¨çº¿</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-console text-muted">å‰©ä½™ç©ºåº§</span>
        <select id="emptySeats" class="bg-panel border border-border rounded-lg px-3 py-2 text-big text-gray-100 focus:ring-2 focus:ring-accent">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
        <span class="text-lg">ğŸ’º</span>
      </div>
    </header>

    <!-- ç”¨æˆ·ä¸é€€å‡ºï¼ˆå°å­—ï¼‰ -->
    <div class="flex justify-end gap-2 mb-2">
      <span id="userName" class="text-sm text-muted"></span>
      <button type="button" id="btnLogout" class="text-sm text-muted hover:text-gray-100 underline">é€€å‡º</button>
    </div>

    <!-- ========== åŒºå—ä¸€ï¼šå®æ—¶é›·è¾¾ä¸æˆ‘çš„è½¦å¢ ========== -->
    <section class="bg-panel border border-border rounded-2xl p-5 mb-5 shadow-xl">
      <h2 class="text-muted text-console font-medium mb-3 flex items-center gap-2">
        <span aria-hidden="true">ğŸ“</span> æˆ‘çš„ä½ç½®
      </h2>
      <div class="flex gap-3 items-stretch">
        <input type="text" id="driverLoc" readonly
          class="flex-1 bg-[#0c0c0f] border border-border rounded-xl px-4 py-4 text-big text-gray-100 placeholder-gray-500"
          placeholder="ç‚¹å‡»å³ä¾§è·å–å®šä½" />
        <button type="button" id="btnRefreshGps" class="btn-touch shrink-0 bg-accent hover:bg-blue-600 text-white font-medium rounded-xl px-4 flex items-center gap-2 shadow-lg">
          <span aria-hidden="true">ğŸ¯</span>
          <span class="hidden sm:inline">åˆ·æ–° GPS</span>
        </button>
      </div>
      <p id="gpsStatus" class="text-sm text-muted mt-2"></p>

      <h3 class="text-muted text-console font-medium mt-5 mb-3 flex items-center gap-2">
        <span aria-hidden="true">ğŸ‘¥</span> å½“å‰è½¦ä¸Šä¹˜å®¢
      </h3>
      <ul id="passengerList" class="space-y-3">
        <!-- åŠ¨æ€æ’å…¥ï¼šæ¯è¡Œ [ 1å·å®¢ ] èµ·ç‚¹ â†’ ç»ˆç‚¹ (çŠ¶æ€) [ âœ–ï¸ ä¸‹è½¦ ] -->
      </ul>
      <p id="noPassengersHint" class="text-muted text-console py-2">æš‚æ— ä¹˜å®¢ï¼ŒæŠ¢åˆ°å•åç‚¹ä¸‹æ–¹ã€Œæ·»åŠ è‡³æˆ‘çš„è½¦å¢ã€</p>

      <!-- å…¥å£ä¸»æ“ä½œï¼šæŒ‰ç©ºåº§æ˜¾ç¤ºã€Œæ˜¾ç¤ºåœ°å›¾ã€æˆ–ã€Œç»§ç»­æ¥å•ã€ -->
      <div id="entryActions" class="mt-6 flex flex-col gap-3">
        <a id="btnShowMap" href="map.html" target="_blank" rel="noopener" class="hidden w-full py-4 rounded-xl bg-accent hover:bg-blue-600 text-white font-medium text-center text-big">
          ğŸ—ºï¸ æ˜¾ç¤ºåœ°å›¾
        </a>
        <button type="button" id="btnContinueMatch" class="hidden w-full py-4 rounded-xl border-2 border-success text-success font-medium text-big">
          ğŸ’º ç»§ç»­æ¥å•
        </button>
        <p id="entryHint" class="text-sm text-muted text-center"></p>
      </div>
    </section>

    <!-- ========== åŒºå—äºŒï¼šAI è°ƒåº¦æ¨¡å¼æ§åˆ¶å° ========== -->
    <section class="bg-panel border border-border rounded-2xl p-5 mb-5 shadow-xl">
      <h2 class="text-muted text-console font-medium mb-4 flex items-center gap-2">
        <span aria-hidden="true">ğŸ§ </span> è°ƒåº¦æ¨¡å¼
      </h2>
      <div class="grid grid-cols-1 gap-3">
        <button type="button" data-mode="mode1" class="mode-btn btn-touch rounded-xl border-2 px-4 py-4 text-left flex items-center gap-3 bg-panel border-border hover:border-accent transition-colors">
          <span class="text-2xl">ğŸ“…</span>
          <span class="text-big font-medium">ä¸‹æ¬¡è®¡åˆ’</span>
        </button>
        <button type="button" data-mode="mode2" class="mode-btn btn-touch rounded-xl border-2 px-4 py-4 text-left flex items-center gap-3 bg-panel border-border hover:border-accent transition-colors">
          <span class="text-2xl">ğŸš—</span>
          <span class="text-big font-medium">åŠè·¯å¸å°˜å™¨</span>
        </button>
        <button type="button" data-mode="mode3" class="mode-btn btn-touch rounded-xl border-2 px-4 py-4 text-left flex items-center gap-3 bg-panel border-border hover:border-accent transition-colors">
          <span class="text-2xl">ğŸ”„</span>
          <span class="text-big font-medium">é™„è¿‘æ¥åŠ›</span>
        </button>
        <button type="button" data-mode="pause" class="mode-btn btn-touch rounded-xl border-2 px-4 py-4 text-left flex items-center gap-3 bg-panel border-border hover:border-accent transition-colors">
          <span class="text-2xl">â¸</span>
          <span class="text-big font-medium">åœæ­¢æ¥å•</span>
        </button>
      </div>

      <!-- ä¸‹æ¬¡è®¡åˆ’å±•å¼€ï¼šå¤šæ‰¹æ¬¡ï¼ˆæ™šå›ç¨‹ã€æ¬¡æ—¥å‡ºå‘ã€æ¬¡æ—¥å›ç¨‹â€¦æ¢å­/è°ƒåº¦æŒ‰æ¯æ¡æ‰¾å•ï¼‰ -->
      <div id="planPanel" class="mt-4 p-4 rounded-xl bg-[#0c0c0f] border border-border hidden">
        <div id="planList" class="space-y-4 mb-4"></div>
        <button type="button" id="btnAddPlan" class="w-full py-3 rounded-xl border border-dashed border-border text-muted font-medium mb-3">ï¼‹ æ·»åŠ ä¸‹ä¸€æ‰¹è®¡åˆ’</button>
        <p class="text-sm text-muted">æŒ‰æ—¶é—´æ’åºï¼Œä¼˜å…ˆç¬¬ 1 æ‰¹æ‰¾å•ã€‚è®¡åˆ’ä¸åˆ ï¼›å½“å‰æ‰¹è·‘å®Œåç‚¹ã€Œç»“æŸæ‰¾å•ã€å³å¯è¿›å…¥ä¸‹ä¸€æ‰¹ï¼Œå†å²è®¡åˆ’ä¿ç•™ã€‚</p>
      </div>

      <!-- å‚æ•°å¾®è°ƒ -->
      <div class="mt-5 pt-4 border-t border-border">
        <p class="text-muted text-sm mb-3">ç»•è·¯å®¹å¿åº¦ï¼ˆåˆ†é’Ÿï¼‰</p>
        <div class="flex items-center gap-4">
          <button type="button" id="detourMinus" class="btn-touch w-12 h-12 rounded-xl bg-panel border border-border text-xl font-bold hover:bg-border">âˆ’</button>
          <span id="detourVal" class="text-big font-semibold min-w-[3rem] text-center">15</span>
          <button type="button" id="detourPlus" class="btn-touch w-12 h-12 rounded-xl bg-panel border border-border text-xl font-bold hover:bg-border">+</button>
        </div>
        <p class="text-muted text-sm mt-4 mb-3">é«˜æ”¶ç›Šé—¨æ§›ï¼ˆå…ƒï¼‰</p>
        <div class="flex items-center gap-4">
          <button type="button" id="profitMinus" class="btn-touch w-12 h-12 rounded-xl bg-panel border border-border text-xl font-bold hover:bg-border">âˆ’</button>
          <span id="profitVal" class="text-big font-semibold min-w-[3rem] text-center">100</span>
          <button type="button" id="profitPlus" class="btn-touch w-12 h-12 rounded-xl bg-panel border border-border text-xl font-bold hover:bg-border">+</button>
        </div>
      </div>
    </section>

    <!-- ========== åŒºå—ä¸‰ï¼šæˆ˜åˆ©å“å±•ç¤ºåŒº ========== -->
    <section class="bg-panel border border-border rounded-2xl p-5 mb-5 shadow-xl">
      <h2 class="text-muted text-console font-medium mb-3 flex items-center gap-2">
        <span aria-hidden="true">ğŸ’¸</span> é¡ºè·¯å•ï¼ˆæŠ¢åˆ°åç‚¹æ·»åŠ ï¼‰
      </h2>
      <p id="pushEventsStatus" class="text-sm text-muted mb-3">æœªè¿æ¥æ¨é€æ—¶ä»… Bark æé†’ï¼›é…ç½® Supabase åæ­¤å¤„å®æ—¶æ˜¾ç¤ºã€‚</p>
      <ul id="pushEventsList" class="space-y-4 max-h-[50vh] overflow-y-auto">
        <!-- Realtime æ¨é€çš„å¡ç‰‡åŠ¨æ€æ’å…¥ -->
      </ul>
    </section>

    <!-- å…¨å±åœ°å›¾ï¼ˆå•ç‹¬æ ‡ç­¾é¡µï¼‰ -->
    <section class="bg-panel border border-border rounded-2xl p-5 mb-5 shadow-xl">
      <h2 class="text-muted text-console font-medium mb-3">ğŸ—ºï¸ è·¯çº¿åœ°å›¾</h2>
      <a href="map.html" target="_blank" rel="noopener" class="block w-full py-4 rounded-xl bg-accent hover:bg-blue-600 text-white font-medium text-center text-big">
        æ‰“å¼€å…¨å±åœ°å›¾
      </a>
      <p class="text-sm text-muted mt-2">åœ¨æ–°æ ‡ç­¾é¡µå…¨å±æ˜¾ç¤ºå¸æœºèµ·ç‚¹ä¸ä¹˜å®¢èµ·ç»ˆç‚¹è·¯çº¿ï¼Œæ•°æ®ä¸å½“å‰ã€Œæˆ‘çš„ä½ç½®ã€ã€Œè½¦ä¸Šä¹˜å®¢ã€åŒæ­¥ã€‚</p>
    </section>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
(function () {
  var STORAGE_API = "smartdiaodu_api_base";
  var STORAGE_TOKEN = "smartdiaodu_token";
  var STORAGE_USERNAME = "smartdiaodu_username";
  var STORAGE_SUPABASE_URL = "smartdiaodu_supabase_url";
  var STORAGE_SUPABASE_ANON = "smartdiaodu_supabase_anon_key";
  var STORAGE_DRIVER_LOC = "smartdiaodu_driver_loc";
  var STORAGE_PICKUPS = "smartdiaodu_pickups";
  var STORAGE_DELIVERIES = "smartdiaodu_deliveries";
  var STORAGE_DRIVER_ID = "smartdiaodu_driver_id";
  var DEFAULT_DRIVER_ID = "a0000001-0000-4000-8000-000000000001";

  var pickups = [];
  var deliveries = [];
  var passengerRows = [];  // { id, pickup, delivery } ç”¨äºä¸‹è½¦æ—¶æ›´æ–° DB

  function getDriverId() {
    return (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_DRIVER_ID)) ||
      (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.driverId) || DEFAULT_DRIVER_ID;
  }
  function getSupabaseClient() {
    var url = getSupabaseUrl(), anon = getSupabaseAnon();
    if (!url || !anon || !window.supabase) return null;
    return window.supabase.createClient(url, anon);
  }

  function saveStateToStorage() {
    if (typeof localStorage === "undefined") return;
    var loc = document.getElementById("driverLoc");
    if (loc) localStorage.setItem(STORAGE_DRIVER_LOC, loc.value.trim());
    localStorage.setItem(STORAGE_PICKUPS, JSON.stringify(pickups));
    localStorage.setItem(STORAGE_DELIVERIES, JSON.stringify(deliveries));
  }
  function applyPassengerRows() {
    pickups = passengerRows.map(function (r) { return r.pickup; });
    deliveries = passengerRows.map(function (r) { return r.delivery; });
  }

  function getApiBase() {
    var v = (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_API)) || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.apiBase) || "";
    return (v || "").trim().replace(/\/$/, "");
  }
  function getSupabaseUrl() { return (typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_SUPABASE_URL) : "") || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.supabaseUrl) || ""; }
  function getSupabaseAnon() { return (typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_SUPABASE_ANON) : "") || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.supabaseAnonKey) || ""; }

  function renderPassengerList() {
    var list = document.getElementById("passengerList");
    var hint = document.getElementById("noPassengersHint");
    list.innerHTML = "";
    var len = passengerRows.length > 0 ? passengerRows.length : pickups.length;
    if (len === 0) {
      hint.classList.remove("hidden");
      return;
    }
    hint.classList.add("hidden");
    for (var idx = 0; idx < len; idx++) {
      (function (i) {
        var row = passengerRows[i];
        var p = row ? row.pickup : (pickups[i] || "");
        var d = row ? row.delivery : (deliveries[i] || "");
        var orderId = row && row.id ? row.id : "";
        var shortP = p.length > 12 ? p.slice(0, 12) + "â€¦" : p;
        var shortD = d.length > 12 ? d.slice(0, 12) + "â€¦" : d;
        var li = document.createElement("li");
        li.className = "flex items-center justify-between gap-3 p-3 rounded-xl bg-[#0c0c0f] border border-border";
        li.innerHTML = "<span class=\"text-console flex-1 min-w-0\"><strong>" + (i + 1) + "å·å®¢</strong> " + shortP + " â†’ " + shortD + "</span>" +
          "<button type=\"button\" class=\"drop-passenger shrink-0 px-3 py-2 rounded-lg bg-danger/20 text-danger font-medium\" data-idx=\"" + i + "\" data-order-id=\"" + (orderId || "") + "\" data-delivery=\"" + (d || "").replace(/"/g, "&quot;") + "\">âœ–ï¸ ä¸‹è½¦</button>";
        li.querySelector(".drop-passenger").onclick = function () {
          var idx = parseInt(this.getAttribute("data-idx"), 10);
          var oid = this.getAttribute("data-order-id");
          var dest = this.getAttribute("data-delivery") || (deliveries[idx] || "");
          if (oid && getSupabaseClient()) {
            dropOffAndUpdateDb(oid, dest, idx);
          } else {
            passengerRows.splice(idx, 1);
            if (passengerRows.length === 0) { pickups = []; deliveries = []; } else { applyPassengerRows(); }
            if (dest) document.getElementById("driverLoc").value = dest;
            renderPassengerList();
            saveStateToStorage();
          }
        };
        list.appendChild(li);
      })(idx);
    }
  }

  function loadFromDb(cb) {
    var sup = getSupabaseClient();
    if (!sup) {
      try {
        var p = localStorage.getItem(STORAGE_PICKUPS), d = localStorage.getItem(STORAGE_DELIVERIES);
        if (p) pickups = JSON.parse(p);
        if (d) deliveries = JSON.parse(d);
        passengerRows = pickups.map(function (pu, i) { return { id: null, pickup: pu, delivery: deliveries[i] || "" }; });
        applyPassengerRows();
      } catch (e) {}
      if (cb) cb();
      return;
    }
    var driverId = getDriverId();
    sup.from("driver_state").select("current_loc, empty_seats").eq("driver_id", driverId).maybeSingle()
      .then(function (r) {
        var locEl = document.getElementById("driverLoc");
        var seatsEl = document.getElementById("emptySeats");
        if (r.data && locEl) { locEl.value = r.data.current_loc || ""; }
        if (r.data && seatsEl) { seatsEl.value = String(Math.max(0, Math.min(4, r.data.empty_seats || 0))); }
        return sup.from("order_pool").select("id, pickup, delivery").eq("assigned_driver_id", driverId).eq("status", "assigned");
      })
      .then(function (r) {
        if (r.data && Array.isArray(r.data)) {
          passengerRows = r.data.map(function (o) { return { id: o.id, pickup: o.pickup || "", delivery: o.delivery || "" }; });
        } else {
          passengerRows = [];
        }
        applyPassengerRows();
        renderPassengerList();
        saveStateToStorage();
        updateEntryActions();
        if (cb) cb();
      })
      .catch(function (e) {
        updateEntryActions();
        if (cb) cb();
      });
  }

  function updateEntryActions() {
    var seatsEl = document.getElementById("emptySeats");
    var emptySeats = seatsEl ? Math.max(0, parseInt(seatsEl.value, 10) || 0) : 0;
    var btnMap = document.getElementById("btnShowMap");
    var btnMatch = document.getElementById("btnContinueMatch");
    var hint = document.getElementById("entryHint");
    if (!btnMap || !btnMatch) return;
    if (emptySeats === 0) {
      btnMap.classList.remove("hidden");
      btnMatch.classList.add("hidden");
      if (hint) hint.textContent = "è½¦å·²æ»¡ï¼Œæ‰“å¼€åœ°å›¾æŒ‰è·¯çº¿æ¥é€ï¼›åˆ°è¾¾æ¯ç«™ååœ¨åœ°å›¾é¡µç‚¹ã€Œå·²åˆ°è¾¾ã€æ¨è¿›ã€‚";
    } else {
      btnMap.classList.remove("hidden");
      btnMatch.classList.remove("hidden");
      if (hint) hint.textContent = "æœ‰ç©ºä½ï¼Œç‚¹ã€Œç»§ç»­æ¥å•ã€è®©åç«¯åŒ¹é…é¡ºè·¯å•ï¼›ä¹Ÿå¯æ‰“å¼€åœ°å›¾æŸ¥çœ‹å½“å‰è·¯çº¿ã€‚";
    }
  }

  function dropOffAndUpdateDb(orderId, newLoc, idx) {
    var sup = getSupabaseClient();
    if (!sup) return;
    var driverId = getDriverId();
    sup.from("driver_state").select("empty_seats").eq("driver_id", driverId).maybeSingle()
      .then(function (r) {
        var nextSeats = (r.data && r.data.empty_seats != null) ? Math.min(4, r.data.empty_seats + 1) : 1;
        return Promise.all([
          sup.from("driver_state").update({ current_loc: newLoc, empty_seats: nextSeats }).eq("driver_id", driverId),
          sup.from("order_pool").update({ status: "completed", assigned_driver_id: null }).eq("id", orderId)
        ]);
      })
      .then(function () {
        passengerRows.splice(idx, 1);
        applyPassengerRows();
        if (newLoc) document.getElementById("driverLoc").value = newLoc;
        var seatsEl = document.getElementById("emptySeats");
        if (seatsEl) seatsEl.value = String(Math.min(4, parseInt(seatsEl.value, 10) + 1));
        renderPassengerList();
        saveStateToStorage();
      })
      .catch(function (e) {
        document.getElementById("gpsStatus").textContent = "ä¸‹è½¦æ›´æ–°å¤±è´¥: " + (e.message || e);
      });
  }

  function getCurrentState() {
    return {
      driver_loc: document.getElementById("driverLoc").value.trim() || "å¦‚ä¸œå¿å§”å…šæ ¡",
      pickups: pickups.slice(),
      deliveries: deliveries.slice()
    };
  }

  // ---------- åˆ·æ–° GPS ----------
  document.getElementById("btnRefreshGps").onclick = function () {
    var status = document.getElementById("gpsStatus");
    var input = document.getElementById("driverLoc");
    status.textContent = "å®šä½ä¸­â€¦";
    if (!navigator.geolocation) {
      status.textContent = "æµè§ˆå™¨ä¸æ”¯æŒå®šä½";
      return;
    }
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;
        var base = getApiBase();
        if (!base) {
          input.value = lat.toFixed(5) + ", " + lng.toFixed(5);
          status.textContent = "å·²å¡«å…¥ç»çº¬åº¦ï¼ˆæœªé…ç½® API æ— æ³•åæŸ¥åœ°å€ï¼‰";
          return;
        }
        fetch(base + "/reverse_geocode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lat: lat, lng: lng })
        }).then(function (r) { return r.json();         }).then(function (d) {
          input.value = d.address || (lat.toFixed(5) + ", " + lng.toFixed(5));
          status.textContent = "å·²æ›´æ–°ä½ç½®";
          saveStateToStorage();
          var sup = getSupabaseClient();
          if (sup) {
            sup.from("driver_state").update({ current_loc: input.value.trim() }).eq("driver_id", getDriverId()).then(function () {});
          }
        }).catch(function (e) {
          input.value = lat.toFixed(5) + ", " + lng.toFixed(5);
          status.textContent = "åæŸ¥åœ°å€å¤±è´¥ï¼Œå·²å¡«ç»çº¬åº¦";
        });
      },
      function () { status.textContent = "å®šä½å¤±è´¥ï¼Œè¯·å…è®¸ä½ç½®æƒé™"; }
    );
  };

  // ---------- æ¨¡å¼åˆ‡æ¢ ----------
  var modeLabels = { mode1: "ä¸‹æ¬¡è®¡åˆ’", mode2: "åŠè·¯å¸å°˜å™¨", mode3: "é™„è¿‘æ¥åŠ›", pause: "åœæ­¢æ¥å•" };
  function refreshMode() {
    var base = getApiBase();
    if (!base) return;
    fetch(base + "/driver_mode").then(function (r) { return r.json(); }).then(function (d) {
      var mode = d.mode || "mode2";
      document.querySelectorAll(".mode-btn").forEach(function (btn) {
        btn.classList.remove("border-accent", "bg-accent/20");
        if (btn.getAttribute("data-mode") === mode) {
          btn.classList.add("border-accent", "bg-accent/20");
        }
      });
      var planPanel = document.getElementById("planPanel");
      if (planPanel) planPanel.classList.toggle("hidden", mode !== "mode1");
      if (mode === "mode1") loadPlannedTrip();
    });
  }
  function loadPlannedTrip() {
    var base = getApiBase();
    if (!base) return;
    fetch(base + "/planned_trip").then(function (r) { return r.json(); }).then(function (d) {
      var plans = d.plans || [];
      var list = document.getElementById("planList");
      if (!list) return;
      list.innerHTML = "";
      plans.forEach(function (p, idx) {
        var completed = p.completed === true;
        var card = document.createElement("div");
        card.className = "p-4 rounded-xl bg-panel border border-border" + (completed ? " opacity-75" : "");
        card.setAttribute("data-index", String(idx));
        var header = "ç¬¬ " + (idx + 1) + " æ‰¹";
        if (idx === 0 && !completed) header += "ï¼ˆä¼˜å…ˆæ‰¾å•ï¼‰";
        if (completed) header += " Â· å·²ç»“æŸæ‰¾å•";
        card.innerHTML =
          "<div class=\"text-muted text-sm font-medium mb-2\">" + header + "</div>" +
          "<label class=\"block text-muted text-xs mb-1\">å‡ºå‘æ—¶é—´</label>" +
          "<input type=\"text\" class=\"plan-time w-full bg-[#0c0c0f] border border-border rounded-lg px-3 py-2 text-console mb-2\" placeholder=\"06:00 æˆ– 2025-02-22 06:00\" value=\"" + (p.departure_time || "").replace(/"/g, "&quot;") + "\" " + (completed ? "readonly" : "") + " />" +
          "<label class=\"block text-muted text-xs mb-1\">å‡ºå‘åœ°</label>" +
          "<input type=\"text\" class=\"plan-origin w-full bg-[#0c0c0f] border border-border rounded-lg px-3 py-2 text-console mb-2\" placeholder=\"å¦‚ä¸œè£ç”ŸèŠ±è‹‘\" value=\"" + (p.origin || "").replace(/"/g, "&quot;") + "\" " + (completed ? "readonly" : "") + " />" +
          "<label class=\"block text-muted text-xs mb-1\">ç›®çš„åœ°</label>" +
          "<input type=\"text\" class=\"plan-dest w-full bg-[#0c0c0f] border border-border rounded-lg px-3 py-2 text-console mb-3\" placeholder=\"ä¸Šæµ·\" value=\"" + (p.destination || "").replace(/"/g, "&quot;") + "\" " + (completed ? "readonly" : "") + " />" +
          "<div class=\"flex gap-2\">" +
          (completed ? "" : "<button type=\"button\" class=\"plan-save px-3 py-2 rounded-lg bg-accent text-white text-sm\">ä¿å­˜</button><button type=\"button\" class=\"plan-complete px-3 py-2 rounded-lg border border-muted text-muted text-sm\">ç»“æŸæ‰¾å•</button>") +
          "</div>";
        if (!completed) {
          card.querySelector(".plan-save").onclick = function () { savePlanAt(idx); };
          card.querySelector(".plan-complete").onclick = function () { completePlanAt(idx); };
        }
        list.appendChild(card);
      });
    });
  }
  function completePlanAt(idx) {
    var base = getApiBase();
    if (!base) return;
    if (!confirm("æœ¬æ‰¹æ‰¾å•ä»»åŠ¡ç»“æŸï¼Ÿè®¡åˆ’ä¿ç•™ï¼Œä¸‹ä¸€æ‰¹å°†è‡ªåŠ¨æ¥ä¸Šã€‚")) return;
    fetch(base + "/planned_trip/complete?index=" + idx, { method: "POST" })
      .then(function () { document.getElementById("gpsStatus").textContent = "å·²ç»“æŸæ‰¾å•ï¼Œä¸‹ä¸€æ‰¹æ¥ä¸Š"; loadPlannedTrip(); });
  }
  function savePlanAt(idx) {
    var base = getApiBase();
    if (!base) return;
    var card = document.querySelector("#planList [data-index=\"" + idx + "\"]");
    if (!card) return;
    var body = {
      index: idx,
      origin: (card.querySelector(".plan-origin").value || "").trim() || "å¦‚ä¸œè£ç”ŸèŠ±è‹‘",
      destination: (card.querySelector(".plan-dest").value || "").trim() || "ä¸Šæµ·",
      departure_time: (card.querySelector(".plan-time").value || "").trim() || "06:00",
      time_window_minutes: 30,
      min_orders: 2,
      max_orders: 4
    };
    fetch(base + "/planned_trip", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) })
      .then(function () { document.getElementById("gpsStatus").textContent = "ç¬¬ " + (idx + 1) + " æ‰¹è®¡åˆ’å·²ä¿å­˜"; loadPlannedTrip(); });
  }
  document.getElementById("btnAddPlan").onclick = function () {
    var base = getApiBase();
    if (!base) return;
    var body = { origin: "å¦‚ä¸œè£ç”ŸèŠ±è‹‘", destination: "ä¸Šæµ·", departure_time: "06:00", time_window_minutes: 30, min_orders: 2, max_orders: 4 };
    fetch(base + "/planned_trip", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) })
      .then(function () { document.getElementById("gpsStatus").textContent = "å·²æ·»åŠ ä¸€æ‰¹ï¼Œè¯·å¡«å†™æ—¶é—´ä¸åœ°ç‚¹åä¿å­˜"; loadPlannedTrip(); });
  };
  document.querySelectorAll(".mode-btn").forEach(function (btn) {
    btn.onclick = function () {
      var mode = this.getAttribute("data-mode");
      var base = getApiBase();
      if (!base) return;
      fetch(base + "/driver_mode", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode: mode }) })
        .then(function () { refreshMode(); });
    };
  });

  // ---------- å‚æ•°å¾®è°ƒï¼ˆç»•è·¯å®¹å¿ = mode2_detour_maxï¼Œé«˜æ”¶ç›Š = mode2_high_profit_thresholdï¼‰ ----------
  function loadConfig() {
    var base = getApiBase();
    if (!base) return;
    fetch(base + "/driver_mode_config").then(function (r) { return r.json(); }).then(function (c) {
      document.getElementById("detourVal").textContent = c.mode2_detour_max != null ? c.mode2_detour_max : 15;
      document.getElementById("profitVal").textContent = c.mode2_high_profit_threshold != null ? c.mode2_high_profit_threshold : 100;
    });
  }
  function saveDetour(v) {
    var base = getApiBase();
    if (!base) return;
    fetch(base + "/driver_mode_config", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode2_detour_max: v }) });
  }
  function saveProfit(v) {
    var base = getApiBase();
    if (!base) return;
    fetch(base + "/driver_mode_config", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode2_high_profit_threshold: v }) });
  }
  document.getElementById("detourMinus").onclick = function () {
    var el = document.getElementById("detourVal");
    var v = Math.max(0, parseInt(el.textContent, 10) - 5);
    el.textContent = v;
    saveDetour(v);
  };
  document.getElementById("detourPlus").onclick = function () {
    var el = document.getElementById("detourVal");
    var v = parseInt(el.textContent, 10) + 5;
    el.textContent = v;
    saveDetour(v);
  };
  document.getElementById("profitMinus").onclick = function () {
    var el = document.getElementById("profitVal");
    var v = Math.max(0, parseInt(el.textContent, 10) - 10);
    el.textContent = v;
    saveProfit(v);
  };
  document.getElementById("profitPlus").onclick = function () {
    var el = document.getElementById("profitVal");
    var v = parseInt(el.textContent, 10) + 10;
    el.textContent = v;
    saveProfit(v);
  };

  // ---------- æˆ˜åˆ©å“ï¼šæ·»åŠ è‡³è½¦å¢ ----------
  function addPushEvent(row) {
    var list = document.getElementById("pushEventsList");
    if (!list) return;
    var li = document.createElement("li");
    li.className = "p-4 rounded-xl bg-[#0c0c0f] border border-border";
    li.setAttribute("data-fingerprint", row.fingerprint || "");
    var extra = row.extra_mins != null ? row.extra_mins : "â€”";
    li.innerHTML = "<div class=\"flex justify-between items-start gap-2 mb-2\">" +
      "<span class=\"text-big font-semibold text-success\">ï¿¥" + (row.price || "0") + "</span>" +
      "<span class=\"text-console text-muted\">ä»…ç»• " + extra + " åˆ†é’Ÿ</span></div>" +
      "<p class=\"text-console text-muted mb-1\">æ¥ï¼š" + (row.pickup || "").slice(0, 28) + (row.pickup && row.pickup.length > 28 ? "â€¦" : "") + "</p>" +
      "<p class=\"text-console text-muted mb-3\">é€ï¼š" + (row.delivery || "").slice(0, 28) + (row.delivery && row.delivery.length > 28 ? "â€¦" : "") + "</p>" +
      "<button type=\"button\" class=\"add-to-cabin w-full py-3 rounded-xl bg-accent hover:bg-blue-600 text-white font-medium\">â• æ·»åŠ è‡³æˆ‘çš„è½¦å¢</button>";
    li.querySelector(".add-to-cabin").onclick = function () {
      var sup = getSupabaseClient();
      if (sup) {
        var driverId = getDriverId();
        sup.from("order_pool").select("id").eq("pickup", row.pickup || "").eq("delivery", row.delivery || "").eq("status", "pending_match").limit(1)
          .then(function (res) {
            if (res.data && res.data[0]) {
              return sup.from("order_pool").update({ status: "assigned", assigned_driver_id: driverId }).eq("id", res.data[0].id)
                .then(function () { return sup.from("driver_state").select("empty_seats").eq("driver_id", driverId).maybeSingle(); })
                .then(function (r) {
                  var next = (r.data && r.data.empty_seats != null) ? Math.max(0, r.data.empty_seats - 1) : 3;
                  return sup.from("driver_state").update({ empty_seats: next }).eq("driver_id", driverId);
                })
                .then(function () { loadFromDb(); });
            }
            passengerRows.push({ id: null, pickup: row.pickup || "", delivery: row.delivery || "" });
            applyPassengerRows();
            renderPassengerList();
            saveStateToStorage();
          });
      } else {
        pickups.push(row.pickup || "");
        deliveries.push(row.delivery || "");
        passengerRows.push({ id: null, pickup: row.pickup || "", delivery: row.delivery || "" });
        renderPassengerList();
        saveStateToStorage();
      }
    };
    list.insertBefore(li, list.firstChild);
    while (list.children.length > 20) list.removeChild(list.lastChild);
    var status = document.getElementById("pushEventsStatus");
    if (status) status.textContent = "æ–°æ¨é€ä¼šå‡ºç°åœ¨ä¸Šæ–¹ï¼›æŠ¢åˆ°åç‚¹ã€Œæ·»åŠ è‡³æˆ‘çš„è½¦å¢ã€ã€‚";
  }
  window.addEventListener("smartdiaodu_push", function (e) { if (e.detail) addPushEvent(e.detail); });

  // ---------- ç™»å½•ä¸é€€å‡º ----------
  if (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_USERNAME)) {
    var un = document.getElementById("userName");
    if (un) un.textContent = "ï¼ˆ" + localStorage.getItem(STORAGE_USERNAME) + "ï¼‰";
  }
  document.getElementById("btnLogout").onclick = function () {
    var url = typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_SUPABASE_URL);
    var anon = typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_SUPABASE_ANON);
    if (url && anon && window.supabase) { try { window.supabase.createClient(url, anon).auth.signOut(); } catch (e) {} }
    if (typeof localStorage !== "undefined") { localStorage.removeItem(STORAGE_TOKEN); localStorage.removeItem(STORAGE_USERNAME); }
    window.location.replace("login.html");
  };

  document.getElementById("btnContinueMatch").onclick = function () {
    var base = getApiBase();
    if (base) {
      fetch(base + "/driver_mode").then(function (r) { return r.json(); }).then(function (d) {
        var mode = d.mode || "mode2";
        if (mode === "pause") {
          fetch(base + "/driver_mode", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode: "mode2" }) }).then(refreshMode);
        }
      });
    }
    document.getElementById("pushEventsList").scrollIntoView({ behavior: "smooth" });
    document.getElementById("gpsStatus").textContent = "åç«¯æ­£åœ¨åŒ¹é…é¡ºè·¯å•ï¼Œæ–°å•ä¼šå‡ºç°åœ¨ä¸‹æ–¹ã€Œé¡ºè·¯å•ã€åŒºåŸŸã€‚";
  };

  function run() {
    var locEl = document.getElementById("driverLoc");
    if (locEl) locEl.addEventListener("change", saveStateToStorage);
    if (locEl) locEl.addEventListener("input", saveStateToStorage);
    document.getElementById("planPanel").classList.add("hidden");
    loadFromDb(function () {
      renderPassengerList();
      updateEntryActions();
      refreshMode();
      loadConfig();
      refreshMode();
      saveStateToStorage();
    });
  }

  function checkAuthAndRun() {
    if (typeof localStorage === "undefined") { window.location.replace("login.html"); return; }
    if (localStorage.getItem(STORAGE_TOKEN)) { run(); return; }
    var url = getSupabaseUrl(), anon = getSupabaseAnon();
    if (!url || !anon || !window.supabase) { window.location.replace("login.html"); return; }
    window.supabase.createClient(url, anon).auth.getSession().then(function (r) {
      if (r.data && r.data.session) run();
      else window.location.replace("login.html");
    }).catch(function () { window.location.replace("login.html"); });
  }
  checkAuthAndRun();
})();
  </script>
  <script type="module">
(function () {
  var STORAGE_SUPABASE_URL = "smartdiaodu_supabase_url";
  var STORAGE_SUPABASE_ANON = "smartdiaodu_supabase_anon_key";
  var url = (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_SUPABASE_URL)) || "";
  var anon = (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_SUPABASE_ANON)) || "";
  if (!url || !anon) return;
  try {
    var createClient = (await import("https://esm.sh/@supabase/supabase-js@2")).createClient;
    var supabase = createClient(url, anon);
    supabase.channel("push_events_channel").on("postgres_changes", { event: "INSERT", schema: "public", table: "push_events" }, function (payload) {
      if (payload && payload.new) window.dispatchEvent(new CustomEvent("smartdiaodu_push", { detail: payload.new }));
    }).subscribe(function (s) {
      var el = document.getElementById("pushEventsStatus");
      if (el) el.textContent = s === "SUBSCRIBED" ? "å·²è¿æ¥ Realtimeï¼Œç­‰å¾…é¡ºè·¯å•â€¦" : "Realtime: " + s;
    });
  } catch (e) {
    var el = document.getElementById("pushEventsStatus");
    if (el) el.textContent = "Realtime è¿æ¥å¤±è´¥: " + (e.message || e);
  }
})();
  </script>
</body>
</html>

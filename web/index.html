<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0c0f" />
  <title>é¡ºé£è½¦è°ƒåº¦ Â· æ§åˆ¶å°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            panel: '#14151a',
            border: '#2a2d35',
            muted: '#8b9199',
            accent: '#3b82f6',
            success: '#22c55e',
            danger: '#ef4444',
          },
          fontSize: {
            'console': ['1.125rem', { lineHeight: '1.5' }],
            'big': ['1.35rem', { lineHeight: '1.4' }],
            'hero': ['1.6rem', { lineHeight: '1.3' }],
          },
        },
      },
    };
  </script>
  <style>
    body { -webkit-tap-highlight-color: transparent; }
    .btn-touch { min-height: 48px; min-width: 48px; }
    input, select, button { font-size: inherit; }
  </style>
</head>
<body class="bg-[#0c0c0f] text-gray-100 min-h-screen font-sans antialiased pb-8">
  <div class="max-w-lg mx-auto px-4 pt-4">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-success animate-pulse" aria-hidden="true"></span>
        <span class="text-console text-muted">AI å¤§è„‘åœ¨çº¿</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-console text-muted">å‰©ä½™ç©ºåº§</span>
        <select id="emptySeats" class="bg-panel border border-border rounded-lg px-3 py-2 text-big text-gray-100 focus:ring-2 focus:ring-accent">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
        <span class="text-lg">ğŸ’º</span>
      </div>
    </header>

    <!-- ç”¨æˆ·ä¸é€€å‡ºï¼ˆå°å­—ï¼‰ -->
    <div class="flex justify-end gap-2 mb-2">
      <span id="userName" class="text-sm text-muted"></span>
      <button type="button" id="btnLogout" class="text-sm text-muted hover:text-gray-100 underline">é€€å‡º</button>
    </div>

    <!-- ========== åŒºå—ä¸€ï¼šå®æ—¶é›·è¾¾ä¸æˆ‘çš„è½¦å¢ ========== -->
    <section class="bg-panel border border-border rounded-2xl p-5 mb-5 shadow-xl">
      <h2 class="text-muted text-console font-medium mb-3 flex items-center gap-2">
        <span aria-hidden="true">ğŸ“</span> æˆ‘çš„ä½ç½®
      </h2>
      <div class="flex gap-3 items-stretch">
        <input type="text" id="driverLoc" readonly
          class="flex-1 bg-[#0c0c0f] border border-border rounded-xl px-4 py-4 text-big text-gray-100 placeholder-gray-500"
          placeholder="ç‚¹å‡»å³ä¾§è·å–å®šä½" />
        <button type="button" id="btnRefreshGps" class="btn-touch shrink-0 bg-accent hover:bg-blue-600 text-white font-medium rounded-xl px-4 flex items-center gap-2 shadow-lg">
          <span aria-hidden="true">ğŸ¯</span>
          <span class="hidden sm:inline">åˆ·æ–° GPS</span>
        </button>
      </div>
      <p id="gpsStatus" class="text-sm text-muted mt-2"></p>

      <h3 class="text-muted text-console font-medium mt-5 mb-3 flex items-center gap-2">
        <span aria-hidden="true">ğŸ‘¥</span> å½“å‰è½¦ä¸Šä¹˜å®¢
      </h3>
      <ul id="passengerList" class="space-y-3">
        <!-- åŠ¨æ€æ’å…¥ï¼šæ¯è¡Œ [ 1å·å®¢ ] èµ·ç‚¹ â†’ ç»ˆç‚¹ (çŠ¶æ€) [ âœ–ï¸ ä¸‹è½¦ ] -->
      </ul>
      <p id="noPassengersHint" class="text-muted text-console py-2">æš‚æ— ä¹˜å®¢ï¼ŒæŠ¢åˆ°å•åç‚¹ä¸‹æ–¹ã€Œæ·»åŠ è‡³æˆ‘çš„è½¦å¢ã€</p>
    </section>

    <!-- ========== åŒºå—äºŒï¼šAI è°ƒåº¦æ¨¡å¼æ§åˆ¶å° ========== -->
    <section class="bg-panel border border-border rounded-2xl p-5 mb-5 shadow-xl">
      <h2 class="text-muted text-console font-medium mb-4 flex items-center gap-2">
        <span aria-hidden="true">ğŸ§ </span> è°ƒåº¦æ¨¡å¼
      </h2>
      <div class="grid grid-cols-1 gap-3">
        <button type="button" data-mode="mode1" class="mode-btn btn-touch rounded-xl border-2 px-4 py-4 text-left flex items-center gap-3 bg-panel border-border hover:border-accent transition-colors">
          <span class="text-2xl">ğŸŒ™</span>
          <span class="text-big font-medium">æ˜æ—¥è®¡åˆ’</span>
        </button>
        <button type="button" data-mode="mode2" class="mode-btn btn-touch rounded-xl border-2 px-4 py-4 text-left flex items-center gap-3 bg-panel border-border hover:border-accent transition-colors">
          <span class="text-2xl">ğŸš—</span>
          <span class="text-big font-medium">åŠè·¯å¸å°˜å™¨</span>
        </button>
        <button type="button" data-mode="mode3" class="mode-btn btn-touch rounded-xl border-2 px-4 py-4 text-left flex items-center gap-3 bg-panel border-border hover:border-accent transition-colors">
          <span class="text-2xl">ğŸ”„</span>
          <span class="text-big font-medium">é™„è¿‘æ¥åŠ›</span>
        </button>
        <button type="button" data-mode="pause" class="mode-btn btn-touch rounded-xl border-2 px-4 py-4 text-left flex items-center gap-3 bg-panel border-border hover:border-accent transition-colors">
          <span class="text-2xl">â¸</span>
          <span class="text-big font-medium">åœæ­¢æ¥å•</span>
        </button>
      </div>

      <!-- æ˜æ—¥è®¡åˆ’å±•å¼€ï¼šæ—¶é—´ + ç›®çš„åœ° -->
      <div id="planPanel" class="mt-4 p-4 rounded-xl bg-[#0c0c0f] border border-border hidden">
        <label class="block text-muted text-sm mb-1">è®¡åˆ’å‡ºå‘æ—¶é—´</label>
        <input type="text" id="planTime" placeholder="06:00" class="w-full bg-panel border border-border rounded-lg px-3 py-3 text-console mb-3" />
        <label class="block text-muted text-sm mb-1">ç›®çš„åœ°</label>
        <input type="text" id="planDest" placeholder="ä¸Šæµ·" class="w-full bg-panel border border-border rounded-lg px-3 py-3 text-console mb-3" />
        <label class="block text-muted text-sm mb-1">å‡ºå‘åœ°ï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" id="planOrigin" placeholder="å¦‚ä¸œè£ç”ŸèŠ±è‹‘" class="w-full bg-panel border border-border rounded-lg px-3 py-3 text-console mb-3" />
        <button type="button" id="btnSavePlan" class="bg-accent text-white px-4 py-3 rounded-lg font-medium">ä¿å­˜è§„åˆ’</button>
      </div>

      <!-- å‚æ•°å¾®è°ƒ -->
      <div class="mt-5 pt-4 border-t border-border">
        <p class="text-muted text-sm mb-3">ç»•è·¯å®¹å¿åº¦ï¼ˆåˆ†é’Ÿï¼‰</p>
        <div class="flex items-center gap-4">
          <button type="button" id="detourMinus" class="btn-touch w-12 h-12 rounded-xl bg-panel border border-border text-xl font-bold hover:bg-border">âˆ’</button>
          <span id="detourVal" class="text-big font-semibold min-w-[3rem] text-center">15</span>
          <button type="button" id="detourPlus" class="btn-touch w-12 h-12 rounded-xl bg-panel border border-border text-xl font-bold hover:bg-border">+</button>
        </div>
        <p class="text-muted text-sm mt-4 mb-3">é«˜æ”¶ç›Šé—¨æ§›ï¼ˆå…ƒï¼‰</p>
        <div class="flex items-center gap-4">
          <button type="button" id="profitMinus" class="btn-touch w-12 h-12 rounded-xl bg-panel border border-border text-xl font-bold hover:bg-border">âˆ’</button>
          <span id="profitVal" class="text-big font-semibold min-w-[3rem] text-center">100</span>
          <button type="button" id="profitPlus" class="btn-touch w-12 h-12 rounded-xl bg-panel border border-border text-xl font-bold hover:bg-border">+</button>
        </div>
      </div>
    </section>

    <!-- ========== åŒºå—ä¸‰ï¼šæˆ˜åˆ©å“å±•ç¤ºåŒº ========== -->
    <section class="bg-panel border border-border rounded-2xl p-5 mb-5 shadow-xl">
      <h2 class="text-muted text-console font-medium mb-3 flex items-center gap-2">
        <span aria-hidden="true">ğŸ’¸</span> é¡ºè·¯å•ï¼ˆæŠ¢åˆ°åç‚¹æ·»åŠ ï¼‰
      </h2>
      <p id="pushEventsStatus" class="text-sm text-muted mb-3">æœªè¿æ¥æ¨é€æ—¶ä»… Bark æé†’ï¼›é…ç½® Supabase åæ­¤å¤„å®æ—¶æ˜¾ç¤ºã€‚</p>
      <ul id="pushEventsList" class="space-y-4 max-h-[50vh] overflow-y-auto">
        <!-- Realtime æ¨é€çš„å¡ç‰‡åŠ¨æ€æ’å…¥ -->
      </ul>
    </section>

    <!-- åœ°å›¾ä¸è®¾ç½®æŠ˜å  -->
    <details class="bg-panel border border-border rounded-2xl overflow-hidden mb-4">
      <summary class="p-4 text-muted text-console cursor-pointer select-none">åœ°å›¾ä¸æ›´å¤šè®¾ç½®</summary>
      <div class="p-4 pt-0 border-t border-border space-y-4">
        <div>
          <label class="block text-muted text-sm mb-1">åœ°å›¾ç±»å‹</label>
          <select id="mapType" class="w-full bg-[#0c0c0f] border border-border rounded-lg px-3 py-2">
            <option value="baidu">ç™¾åº¦åœ°å›¾</option>
            <option value="osm">OpenStreetMap</option>
          </select>
        </div>
        <div id="map" class="h-64 rounded-xl bg-[#0c0c0f] border border-border"></div>
        <button type="button" id="btnUpdateMap" class="w-full py-3 rounded-xl border border-border hover:bg-border font-medium">æ›´æ–°è·¯çº¿åœ°å›¾</button>
        <p id="routeInfo" class="text-sm text-muted"></p>
      </div>
    </details>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script>
(function () {
  var STORAGE_API = "smartdiaodu_api_base";
  var STORAGE_TOKEN = "smartdiaodu_token";
  var STORAGE_USERNAME = "smartdiaodu_username";
  var STORAGE_SUPABASE_URL = "smartdiaodu_supabase_url";
  var STORAGE_SUPABASE_ANON = "smartdiaodu_supabase_anon_key";

  var pickups = [];
  var deliveries = [];

  function getApiBase() {
    var v = (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_API)) || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.apiBase) || "";
    return (v || "").trim().replace(/\/$/, "");
  }
  function getSupabaseUrl() { return (typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_SUPABASE_URL) : "") || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.supabaseUrl) || ""; }
  function getSupabaseAnon() { return (typeof localStorage !== "undefined" ? localStorage.getItem(STORAGE_SUPABASE_ANON) : "") || (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.supabaseAnonKey) || ""; }

  function renderPassengerList() {
    var list = document.getElementById("passengerList");
    var hint = document.getElementById("noPassengersHint");
    list.innerHTML = "";
    if (pickups.length === 0) {
      hint.classList.remove("hidden");
      return;
    }
    hint.classList.add("hidden");
    for (var i = 0; i < pickups.length; i++) {
      (function (idx) {
        var li = document.createElement("li");
        li.className = "flex items-center justify-between gap-3 p-3 rounded-xl bg-[#0c0c0f] border border-border";
        var shortP = (pickups[idx] || "").length > 12 ? (pickups[idx].slice(0, 12) + "â€¦") : (pickups[idx] || "");
        var shortD = (deliveries[idx] || "").length > 12 ? (deliveries[idx].slice(0, 12) + "â€¦") : (deliveries[idx] || "");
        li.innerHTML = "<span class=\"text-console flex-1 min-w-0\"><strong>" + (idx + 1) + "å·å®¢</strong> " + shortP + " â†’ " + shortD + "</span>" +
          "<button type=\"button\" class=\"drop-passenger shrink-0 px-3 py-2 rounded-lg bg-danger/20 text-danger font-medium\" data-idx=\"" + idx + "\">âœ–ï¸ ä¸‹è½¦</button>";
        li.querySelector(".drop-passenger").onclick = function () {
          var i = parseInt(this.getAttribute("data-idx"), 10);
          var dest = deliveries[i];
          pickups.splice(i, 1);
          deliveries.splice(i, 1);
          if (dest) document.getElementById("driverLoc").value = dest;
          renderPassengerList();
        };
        list.appendChild(li);
      })(i);
    }
  }

  function getCurrentState() {
    return {
      driver_loc: document.getElementById("driverLoc").value.trim() || "å¦‚ä¸œå¿å§”å…šæ ¡",
      pickups: pickups.slice(),
      deliveries: deliveries.slice()
    };
  }

  // ---------- åˆ·æ–° GPS ----------
  document.getElementById("btnRefreshGps").onclick = function () {
    var status = document.getElementById("gpsStatus");
    var input = document.getElementById("driverLoc");
    status.textContent = "å®šä½ä¸­â€¦";
    if (!navigator.geolocation) {
      status.textContent = "æµè§ˆå™¨ä¸æ”¯æŒå®šä½";
      return;
    }
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;
        var base = getApiBase();
        if (!base) {
          input.value = lat.toFixed(5) + ", " + lng.toFixed(5);
          status.textContent = "å·²å¡«å…¥ç»çº¬åº¦ï¼ˆæœªé…ç½® API æ— æ³•åæŸ¥åœ°å€ï¼‰";
          return;
        }
        fetch(base + "/reverse_geocode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lat: lat, lng: lng })
        }).then(function (r) { return r.json(); }).then(function (d) {
          input.value = d.address || (lat.toFixed(5) + ", " + lng.toFixed(5));
          status.textContent = "å·²æ›´æ–°ä½ç½®";
        }).catch(function (e) {
          input.value = lat.toFixed(5) + ", " + lng.toFixed(5);
          status.textContent = "åæŸ¥åœ°å€å¤±è´¥ï¼Œå·²å¡«ç»çº¬åº¦";
        });
      },
      function () { status.textContent = "å®šä½å¤±è´¥ï¼Œè¯·å…è®¸ä½ç½®æƒé™"; }
    );
  };

  // ---------- æ¨¡å¼åˆ‡æ¢ ----------
  var modeLabels = { mode1: "æ˜æ—¥è®¡åˆ’", mode2: "åŠè·¯å¸å°˜å™¨", mode3: "é™„è¿‘æ¥åŠ›", pause: "åœæ­¢æ¥å•" };
  function refreshMode() {
    var base = getApiBase();
    if (!base) return;
    fetch(base + "/driver_mode").then(function (r) { return r.json(); }).then(function (d) {
      var mode = d.mode || "mode2";
      document.querySelectorAll(".mode-btn").forEach(function (btn) {
        btn.classList.remove("border-accent", "bg-accent/20");
        if (btn.getAttribute("data-mode") === mode) {
          btn.classList.add("border-accent", "bg-accent/20");
        }
      });
      var planPanel = document.getElementById("planPanel");
      if (planPanel) planPanel.classList.toggle("hidden", mode !== "mode1");
      if (mode === "mode1") loadPlannedTrip();
    });
  }
  function loadPlannedTrip() {
    var base = getApiBase();
    if (!base) return;
    fetch(base + "/planned_trip").then(function (r) { return r.json(); }).then(function (d) {
      if (d.origin) document.getElementById("planOrigin").value = d.origin;
      if (d.destination) document.getElementById("planDest").value = d.destination;
      if (d.departure_time) document.getElementById("planTime").value = d.departure_time;
    });
  }
  document.querySelectorAll(".mode-btn").forEach(function (btn) {
    btn.onclick = function () {
      var mode = this.getAttribute("data-mode");
      var base = getApiBase();
      if (!base) return;
      fetch(base + "/driver_mode", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode: mode }) })
        .then(function () { refreshMode(); });
    };
  });

  // ---------- æ˜æ—¥è®¡åˆ’ ----------
  document.getElementById("btnSavePlan").onclick = function () {
    var base = getApiBase();
    if (!base) return;
    var body = {
      origin: document.getElementById("planOrigin").value.trim() || "å¦‚ä¸œè£ç”ŸèŠ±è‹‘",
      destination: document.getElementById("planDest").value.trim() || "ä¸Šæµ·",
      departure_time: document.getElementById("planTime").value.trim() || "06:00",
      time_window_minutes: 30,
      min_orders: 2,
      max_orders: 4
    };
    fetch(base + "/planned_trip", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) })
      .then(function () { document.getElementById("gpsStatus").textContent = "è§„åˆ’å·²ä¿å­˜"; });
  };

  // ---------- å‚æ•°å¾®è°ƒï¼ˆç»•è·¯å®¹å¿ = mode2_detour_maxï¼Œé«˜æ”¶ç›Š = mode2_high_profit_thresholdï¼‰ ----------
  function loadConfig() {
    var base = getApiBase();
    if (!base) return;
    fetch(base + "/driver_mode_config").then(function (r) { return r.json(); }).then(function (c) {
      document.getElementById("detourVal").textContent = c.mode2_detour_max != null ? c.mode2_detour_max : 15;
      document.getElementById("profitVal").textContent = c.mode2_high_profit_threshold != null ? c.mode2_high_profit_threshold : 100;
    });
  }
  function saveDetour(v) {
    var base = getApiBase();
    if (!base) return;
    fetch(base + "/driver_mode_config", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode2_detour_max: v }) });
  }
  function saveProfit(v) {
    var base = getApiBase();
    if (!base) return;
    fetch(base + "/driver_mode_config", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode2_high_profit_threshold: v }) });
  }
  document.getElementById("detourMinus").onclick = function () {
    var el = document.getElementById("detourVal");
    var v = Math.max(0, parseInt(el.textContent, 10) - 5);
    el.textContent = v;
    saveDetour(v);
  };
  document.getElementById("detourPlus").onclick = function () {
    var el = document.getElementById("detourVal");
    var v = parseInt(el.textContent, 10) + 5;
    el.textContent = v;
    saveDetour(v);
  };
  document.getElementById("profitMinus").onclick = function () {
    var el = document.getElementById("profitVal");
    var v = Math.max(0, parseInt(el.textContent, 10) - 10);
    el.textContent = v;
    saveProfit(v);
  };
  document.getElementById("profitPlus").onclick = function () {
    var el = document.getElementById("profitVal");
    var v = parseInt(el.textContent, 10) + 10;
    el.textContent = v;
    saveProfit(v);
  };

  // ---------- æˆ˜åˆ©å“ï¼šæ·»åŠ è‡³è½¦å¢ ----------
  function addPushEvent(row) {
    var list = document.getElementById("pushEventsList");
    if (!list) return;
    var li = document.createElement("li");
    li.className = "p-4 rounded-xl bg-[#0c0c0f] border border-border";
    li.setAttribute("data-fingerprint", row.fingerprint || "");
    var extra = row.extra_mins != null ? row.extra_mins : "â€”";
    li.innerHTML = "<div class=\"flex justify-between items-start gap-2 mb-2\">" +
      "<span class=\"text-big font-semibold text-success\">ï¿¥" + (row.price || "0") + "</span>" +
      "<span class=\"text-console text-muted\">ä»…ç»• " + extra + " åˆ†é’Ÿ</span></div>" +
      "<p class=\"text-console text-muted mb-1\">æ¥ï¼š" + (row.pickup || "").slice(0, 28) + (row.pickup && row.pickup.length > 28 ? "â€¦" : "") + "</p>" +
      "<p class=\"text-console text-muted mb-3\">é€ï¼š" + (row.delivery || "").slice(0, 28) + (row.delivery && row.delivery.length > 28 ? "â€¦" : "") + "</p>" +
      "<button type=\"button\" class=\"add-to-cabin w-full py-3 rounded-xl bg-accent hover:bg-blue-600 text-white font-medium\">â• æ·»åŠ è‡³æˆ‘çš„è½¦å¢</button>";
    li.querySelector(".add-to-cabin").onclick = function () {
      pickups.push(row.pickup || "");
      deliveries.push(row.delivery || "");
      renderPassengerList();
    };
    list.insertBefore(li, list.firstChild);
    while (list.children.length > 20) list.removeChild(list.lastChild);
    var status = document.getElementById("pushEventsStatus");
    if (status) status.textContent = "æ–°æ¨é€ä¼šå‡ºç°åœ¨ä¸Šæ–¹ï¼›æŠ¢åˆ°åç‚¹ã€Œæ·»åŠ è‡³æˆ‘çš„è½¦å¢ã€ã€‚";
  }
  window.addEventListener("smartdiaodu_push", function (e) { if (e.detail) addPushEvent(e.detail); });

  // ---------- åœ°å›¾ï¼ˆæ²¿ç”¨åŸé€»è¾‘ï¼‰ ----------
  var map = null, bmap = null, markers = [], routeLine = null, lastRouteData = null;
  var mapTypeEl = document.getElementById("mapType");
  function getBaiduMapAk() { return (typeof window.SMARTDIAODU_CONFIG !== "undefined" && window.SMARTDIAODU_CONFIG.baiduMapAk) || ""; }
  function wgs84ToBd09(lat, lng) {
    var x_PI = (3.14159265358979324 * 3000.0) / 180.0, a = 6378245.0, ee = 0.00669342162296594323;
    function trLat(x, y) {
      var r = -100 + 2 * x + 3 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
      r += (20 * Math.sin(6 * x * Math.PI) + 20 * Math.sin(2 * x * Math.PI)) * 2 / 3;
      r += (20 * Math.sin(y * Math.PI) + 40 * Math.sin(y / 3 * Math.PI)) * 2 / 3;
      return r;
    }
    function trLng(x, y) {
      var r = 300 + x + 2 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
      r += (20 * Math.sin(6 * x * Math.PI) + 20 * Math.sin(2 * x * Math.PI)) * 2 / 3;
      r += (20 * Math.sin(x * Math.PI) + 40 * Math.sin(x / 3 * Math.PI)) * 2 / 3;
      return r;
    }
    var dlat = trLat(lng - 105, lat - 35), dlng = trLng(lng - 105, lat - 35);
    var radlat = (lat / 180) * Math.PI, magic = 1 - ee * Math.sin(radlat) * Math.sin(radlat), sqrtmagic = Math.sqrt(magic);
    dlat = (dlat * 180) / ((a * (1 - ee)) / (magic * sqrtmagic) * Math.PI);
    dlng = (dlng * 180) / (a / sqrtmagic * Math.cos(radlat) * Math.PI);
    var mglat = lat + dlat, mglng = lng + dlng;
    return [mglng + 0.0065 * Math.cos(mglat * x_PI), mglat + 0.006 * Math.sin(mglng * x_PI)];
  }
  function getMapType() { return (mapTypeEl && mapTypeEl.value) || "osm"; }
  function destroyMap() {
    if (map) { map.remove(); map = null; }
    if (bmap) { try { bmap.destroy(); } catch (e) {} bmap = null; }
    markers = []; routeLine = null;
  }
  function initMap() {
    var useBaidu = getMapType() === "baidu";
    var ak = getBaiduMapAk();
    if (useBaidu && !ak) {
      document.getElementById("routeInfo").textContent = "æœªé…ç½®ç™¾åº¦åœ°å›¾ AKï¼Œæˆ–é€‰ OpenStreetMap";
      return;
    }
    destroyMap();
    if (useBaidu) {
      if (!window.BMap) {
        var script = document.createElement("script");
        script.src = "https://api.map.baidu.com/api?v=3.0&ak=" + ak + "&s=1";
        script.onload = function () { initBaiduMap(); if (lastRouteData) drawRoute(lastRouteData); };
        document.head.appendChild(script);
        return;
      }
      initBaiduMap();
      if (lastRouteData) drawRoute(lastRouteData);
      return;
    }
    map = L.map("map").setView([32.0, 121.0], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "Â© OSM" }).addTo(map);
    if (lastRouteData) drawRoute(lastRouteData);
  }
  function initBaiduMap() {
    if (bmap) return;
    bmap = new window.BMap.Map("map");
    bmap.centerAndZoom(new window.BMap.Point(121.0, 32.0), 10);
    bmap.enableScrollWheelZoom(true);
  }
  function clearMapOverlays() {
    if (map) { markers.forEach(function (m) { map.removeLayer(m); }); markers = []; if (routeLine) { map.removeLayer(routeLine); routeLine = null; } }
    if (bmap) bmap.clearOverlays();
  }
  var typeColor = { driver: "#3b82f6", pickup: "#22c55e", delivery: "#ef4444" };
  function drawRoute(data) {
    lastRouteData = data;
    var coords = data.route_coords || [], addresses = data.route_addresses || [], types = data.point_types || [];
    if (coords.length === 0) return;
    clearMapOverlays();
    var useBaidu = getMapType() === "baidu" && bmap;
    if (useBaidu) {
      var points = [];
      coords.forEach(function (c, i) {
        var bd = wgs84ToBd09(c[0], c[1]);
        points.push(new window.BMap.Point(bd[0], bd[1]));
        var mk = new window.BMap.Marker(new window.BMap.Point(bd[0], bd[1]));
        mk.setLabel(new window.BMap.Label((types[i] || "é€”ç»") + (addresses[i] ? " " + addresses[i].slice(0, 10) + "â€¦" : ""), { offset: new window.BMap.Size(10, -10) }));
        bmap.addOverlay(mk);
      });
      bmap.addOverlay(new window.BMap.Polyline(points.map(function (p) { return p; }), { strokeColor: "#3b82f6", strokeWeight: 4 }));
      bmap.setViewport(points);
    } else if (map) {
      var latlngs = coords.map(function (c) { return [c[0], c[1]]; });
      routeLine = L.polyline(latlngs, { color: "#3b82f6", weight: 4 }).addTo(map);
      map.fitBounds(routeLine.getBounds(), { padding: [20, 20] });
      coords.forEach(function (c, i) {
        var color = typeColor[types[i]] || "#888";
        var m = L.circleMarker([c[0], c[1]], { radius: 8, fillColor: color, color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map);
        m.bindPopup(addresses[i] || "");
        markers.push(m);
      });
    }
    document.getElementById("routeInfo").textContent = "é€”ç» " + addresses.length + " ç‚¹ï¼Œé¢„ä¼°çº¦ " + Math.round((data.total_time_seconds || 0) / 60) + " åˆ†é’Ÿ";
  }
  document.getElementById("btnUpdateMap").onclick = function () {
    var base = getApiBase();
    if (!base) return;
    initMap();
    document.getElementById("routeInfo").textContent = "åŠ è½½ä¸­â€¦";
    fetch(base + "/current_route_preview", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ current_state: getCurrentState() }) })
      .then(function (r) { if (!r.ok) return r.json().then(function (d) { throw new Error(d.detail || r.statusText); }); return r.json(); })
      .then(drawRoute)
      .catch(function (e) { document.getElementById("routeInfo").textContent = "å¤±è´¥ï¼š" + (e.message || e); clearMapOverlays(); });
  };

  // ---------- ç™»å½•ä¸é€€å‡º ----------
  if (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_USERNAME)) {
    var un = document.getElementById("userName");
    if (un) un.textContent = "ï¼ˆ" + localStorage.getItem(STORAGE_USERNAME) + "ï¼‰";
  }
  document.getElementById("btnLogout").onclick = function () {
    var url = typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_SUPABASE_URL);
    var anon = typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_SUPABASE_ANON);
    if (url && anon && window.supabase) { try { window.supabase.createClient(url, anon).auth.signOut(); } catch (e) {} }
    if (typeof localStorage !== "undefined") { localStorage.removeItem(STORAGE_TOKEN); localStorage.removeItem(STORAGE_USERNAME); }
    window.location.replace("login.html");
  };

  function run() {
    renderPassengerList();
    refreshMode();
    loadConfig();
    document.getElementById("planPanel").classList.add("hidden");
    refreshMode();
  }

  function checkAuthAndRun() {
    if (typeof localStorage === "undefined") { window.location.replace("login.html"); return; }
    if (localStorage.getItem(STORAGE_TOKEN)) { run(); return; }
    var url = getSupabaseUrl(), anon = getSupabaseAnon();
    if (!url || !anon || !window.supabase) { window.location.replace("login.html"); return; }
    window.supabase.createClient(url, anon).auth.getSession().then(function (r) {
      if (r.data && r.data.session) run();
      else window.location.replace("login.html");
    }).catch(function () { window.location.replace("login.html"); });
  }
  checkAuthAndRun();
})();
  </script>
  <script type="module">
(function () {
  var STORAGE_SUPABASE_URL = "smartdiaodu_supabase_url";
  var STORAGE_SUPABASE_ANON = "smartdiaodu_supabase_anon_key";
  var url = (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_SUPABASE_URL)) || "";
  var anon = (typeof localStorage !== "undefined" && localStorage.getItem(STORAGE_SUPABASE_ANON)) || "";
  if (!url || !anon) return;
  try {
    var createClient = (await import("https://esm.sh/@supabase/supabase-js@2")).createClient;
    var supabase = createClient(url, anon);
    supabase.channel("push_events_channel").on("postgres_changes", { event: "INSERT", schema: "public", table: "push_events" }, function (payload) {
      if (payload && payload.new) window.dispatchEvent(new CustomEvent("smartdiaodu_push", { detail: payload.new }));
    }).subscribe(function (s) {
      var el = document.getElementById("pushEventsStatus");
      if (el) el.textContent = s === "SUBSCRIBED" ? "å·²è¿æ¥ Realtimeï¼Œç­‰å¾…é¡ºè·¯å•â€¦" : "Realtime: " + s;
    });
  } catch (e) {
    var el = document.getElementById("pushEventsStatus");
    if (el) el.textContent = "Realtime è¿æ¥å¤±è´¥: " + (e.message || e);
  }
})();
  </script>
</body>
</html>

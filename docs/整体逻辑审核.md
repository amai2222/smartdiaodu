# 整体逻辑审核结论

审核范围：后端流水线、探针与反馈、前端与配置、数据流一致性。结论：**整体逻辑正确**，已修复 1 处探针占位选择器问题，并记录若干可选项与注意点。

---

## 一、后端 (smartdiaodu.py)

### 1. 评估流水线 `/evaluate_new_order`

- **模式**：`pause` → 直接忽略；`mode1` → 忽略（单笔评估不适用）；`mode2` / `mode3` 进入后续逻辑。✓
- **防骚扰**：先 `_cleanup_pending_response()` 把超时未操作的推送移入 `abandoned_fingerprints`；再判断指纹是否在 `abandoned_fingerprints` / `pushed_orders_cache`（30 分钟）。✓
- **模式 3（有待送客）**：取「当前位→各送客点」最近的一个作为预估送客点；新单起点距该点 ≤ `MODE3_MAX_MINUTES_TO_PICKUP`；剩余路线接单后多绕 ≤ `MODE3_MAX_DETOUR_MINUTES`。✓
- **模式 3（无待送客）**：按「当前位→新单起点」时效卡。✓
- **模式 2**：绕路在 `detour_min` 内直接接；在 `detour_min`～`detour_max` 且收益 ≥ 高收益门槛才接。✓
- **接单后**：写 `pushed_orders_cache`、`pending_response`，调用 `push_to_bark(..., fingerprint)`。✓

### 2. 推送与反馈

- **Bark**：若配置 `RESPONSE_PAGE_BASE`，正文带 `?fp={fingerprint}` 的链接。✓
- **GET /order_response**：`accepted` / `continue_accepting` 解析 "1"/"true"/"yes"；接单时置 `probe_cancel_trip_requested = True`；放弃时加入 `abandoned_fingerprints`；不继续时切到 `pause`。✓
- **超时放弃**：`_cleanup_pending_response()` 仅在**每次进入** `evaluate_new_order` 时执行。因此「超过 RESPONSE_TIMEOUT_SECONDS 未操作则放弃」**只在下次有任意新单被评估时**才会生效；若长期没有新单，该推送单会一直留在 `pending_response` 中直到下次评估。这是当前设计下的合理行为，无需改逻辑，仅需知晓。

### 3. 探针发布行程 POST /probe_publish_trip

- 请求体 `current_state` 解析与校验（driver_loc 必填，pickups/deliveries 数量一致）。✓
- 若 `probe_cancel_trip_requested` 为 True：本次响应带 `cancel_current_trip: true`，并**仅此一次**将其置回 False。✓
- 无已接单时返回起点=终点=司机位置，hint 提示可暂不发布。✓
- 有已接单时：PDP 算路后取「第一个送客点→最后一站」为 origin/destination，depart_time 为当前时分。✓

---

## 二、探针端

### 1. 抓单上报 (uiautomator2_capture / autox_capture)

- 指纹算法与后端一致：`MD5(pickup_delivery_price)`。✓
- 上报 `POST /evaluate_new_order`，body 为 `current_state` + `new_order`。✓

### 2. 发布/取消 (uiautomator2_publish_trip / autox_publish_trip)

- 轮询 `POST /probe_publish_trip`，body `current_state`。✓
- 若返回 `cancel_current_trip === true`：执行取消流程（我的行程/已发布 → 取消 → 确认），不再本次发布。✓
- 若有 `origin` 且 `destination`：填表并点发布。✓
- **已修复**：AutoX 脚本中原来 ORIGIN/DEST 均用 `className("EditText").findOne(2000)`，会拿到**同一个**第一个输入框，导致起点被写两遍、终点未填。已改为用 `find()` 取列表，ORIGIN=第 1 个、DEST=第 2 个 EditText。

### 3. 拟人化与风控

- 发布/取消前有随机延迟；PC 端使用 `common_human.human_delay` / `jitter_interval`。✓
- 文档 `docs/探针端风控与隐蔽策略.md` 与脚本内注释一致。✓

---

## 三、前端

### 1. response.html（接单/停推）

- 从 URL 取 `fp` 或 `fingerprint`，与 Bark 中的 `?fp=xxx` 一致。✓
- 调用 `GET /order_response?fingerprint=...&accepted=0|1&continue_accepting=0|1`，与后端约定一致。✓
- 需在页内或部署时配置 `API_BASE`（或同源时用 `window.location.origin`）。✓

### 2. index.html（控制台）

- 模式：GET/PUT `/driver_mode`；模式参数：GET/PUT `/driver_mode_config`。✓
- 多批次下次计划：GET 返回 `{ "plans": [...] }`，POST 新增、PUT 按 index 更新、DELETE 按 index 删除；探子/调度遍历 plans 按每批找单。✓
- 地图：POST `/current_route_preview`，body `{ current_state }`，用返回的 `route_coords`（WGS84）、`point_types`、`route_addresses` 绘制。✓

---

## 四、数据流小结

1. **抓单 → 评估 → 推送**：探针抓单 → `/evaluate_new_order` → 去重/放弃检查 → 模式与绕路判定 → 写 pending_response + 推 Bark。
2. **用户操作**：点 Bark 链接打开 response 页 → 选接单/不接、是否继续 → `/order_response` 更新 abandoned/pause/探针取消标志。
3. **探针取消**：用户点「接单」→ `probe_cancel_trip_requested = True` → 探针下次轮询 `/probe_publish_trip` 得到 `cancel_current_trip: true` → 在 App 内取消已发布行程。

以上闭环一致，**整体逻辑无误**。

---

## 五、可选与注意事项

- **多司机**：当前为单司机（内存 mode、current_state、probe 状态）；多司机需按 driver_id 读 Supabase 并区分探针/推送对象。
- **模式 1 批量优化**：规划任务 API 与前端已有；从订单池筛 2～4 单并做批量 PDP 的接口与触发逻辑未实现，可后续扩展。
- **探针选择器**：所有 SELECTORS / CANCEL_SELECTORS 仍为示例，需在真机用布局分析或 weditor 按哈啰/滴滴实际界面修改。
- **RESPONSE_PAGE_BASE**：若希望 Bark 正文带可点的反馈链接，需在环境或配置中设置，并确保 response 页已部署且 API 可访问。

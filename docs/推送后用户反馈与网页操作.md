# 推送后用户反馈与网页操作

## 逻辑说明

1. **推送后未操作**  
   大脑推送到 Bark 后，会记录该订单指纹并进入「待响应」列表。若在 **5 分钟内**没有收到你的「接单/不接」反馈，系统会**自动放弃该单并指纹**，之后同一订单（同一起终点+价格）**不再推送**。

2. **你点击了「接单」或「不接」+「是否继续接单」**  
   通过网页或链接调用接口，系统会：
   - **接单**：从待响应中移除，不会因超时被放弃；该单 30 分钟内也不会重复推送。
   - **不接**：将该单指纹加入「已放弃」集合，**以后不再推送这一单**。
   - **是否继续接单**：
     - **是**：保持当前模式（如模式2），继续给你推送顺路单。
     - **否**：切换为 **pause**（停止推送），需要时再在网页或快捷指令里切回模式2。

## 后端配置

- **RESPONSE_TIMEOUT_SECONDS**（默认 300）：推送后多少秒内未操作即视为放弃并指纹该单。
- **RESPONSE_PAGE_BASE**：网页端反馈页的完整基础 URL，如 `https://ui.yourdomain.com/response`。配置后，Bark 正文会带「接单/停推」链接，打开即反馈页（带 `?fp=订单指纹`）。

## 接口

**GET /order_response**

- 参数：`fingerprint`（必填）、`accepted`（0/1 或 true/false）、`continue_accepting`（0/1 或 true/false）。
- 示例：  
  `GET /order_response?fingerprint=abc123&accepted=1&continue_accepting=1`  
  表示：接单，并继续用模式2推送。

| accepted | continue_accepting | 含义 |
|----------|--------------------|------|
| 1 | 1 | 接单，继续接单 |
| 1 | 0 | 接单，暂停推送 |
| 0 | 1 | 不接，继续接单 |
| 0 | 0 | 不接，暂停推送 |

## 网页端

- 将 **web/response.html** 部署到你的前端域名（如 Cloudflare Pages），并配置该页内的 **API_BASE**（或与 API 同源则可不填）。
- 在后台配置 **RESPONSE_PAGE_BASE** 为该页地址，例如：`https://ui.yourdomain.com/response`。
- Bark 推送里会带链接：`https://ui.yourdomain.com/response?fp=订单指纹`，你点开即可选择「接单/不接」与「是否继续接单」。

## 网页内推送（与 Bark 同时）

顺路单除推送到 Bark 外，可**同时**在控制台网页内实时展示，便于开电脑时直接看到并点击「接单/不接」。

1. **数据库**：执行 **supabase/migrations/002_push_events_realtime.sql**，创建 `push_events` 表并加入 Realtime 发布。
2. **后端**：配置 `SUPABASE_URL` 与 `SUPABASE_SERVICE_ROLE_KEY`（或环境变量），每次 Bark 推送时会同步写入一行到 `push_events`。
3. **前端**：在控制台「设置」里填写 **Supabase 项目 URL** 与 **Supabase Anon Key**，保存后刷新。在「行程与地图」下的「实时推送」区会通过 Realtime 订阅收到新推送，并显示接/送/价格/绕路与「接单/不接」链接。
4. 不配置 Supabase 时仅 Bark 推送；配置后 Bark 与网页内推送同时生效。

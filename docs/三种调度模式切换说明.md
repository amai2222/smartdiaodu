# 三种业务模式切换说明（重塑版）

## 模式含义

| 模式值 | 含义 | 大脑行为 |
|--------|------|----------|
| **mode1** | 出发前找单 | 不跑单笔评估；需用规划任务接口设定「出发地、目的地、时间、2～4 单」，由探针/筛选按条件盯单，批量优化接口后续扩展。 |
| **mode2** | 路上接满 | 在规定耽误时间内（默认 20～60 分钟）接顺路单；超过 20 分钟只在高收益（默认 ≥100 元）时放宽到 60 分钟。 |
| **mode3** | 送人后周边接单 | 只考虑「当前位→新单起点」驾车时间 ≤ 设定时效（默认 30 分钟）的单，接单后重规划整条线路。 |
| **pause** | 停止接单 | 不评估、不推送，直接返回 ignored。 |

---

## 实现方式概览

1. **后端**：内存里存当前模式，提供 `GET /driver_mode`、`PUT /driver_mode`，评估时按模式分支。
2. **网页**：调用上述 API 展示当前模式，并提供三个按钮/下拉切换。
3. **快捷指令 / Bark**：用「打开 URL」或「获取 URL 内容」调用 `PUT /driver_mode`，实现手机上一键切换。

---

## 后端 API（已实现）

- **获取当前模式与参数**  
  `GET /driver_mode`  
  响应：`{ "mode": "mode2", "config": { "mode2_detour_min": 20, "mode2_detour_max": 60, "mode2_high_profit_threshold": 100, "mode3_max_minutes_to_pickup": 30, "mode3_max_detour_minutes": 25 } }`  
  （`mode3_max_detour_minutes` = 模式3「剩余路线最多耽误多久」分钟数，送完一客接一单、再送再接的串行时每次都按此卡）

- **切换模式**  
  `PUT /driver_mode`  
  请求体：`{ "mode": "mode1" }` / `"mode2"` / `"mode3"` / `"pause"`  
  响应：`{ "mode": "mode2" }`

- **获取/更新模式参数**  
  `GET /driver_mode_config`、`PUT /driver_mode_config`  
  请求体示例：`{ "mode2_detour_max": 60, "mode3_max_minutes_to_pickup": 20, "mode3_max_detour_minutes": 30 }`（只传要改的字段；`mode3_max_detour_minutes` 即「耽误多久」阈值）

- **模式1 规划任务**  
  `PUT /planned_trip`：`{ "origin": "如东荣生花苑", "destination": "上海", "departure_time": "06:00", "time_window_minutes": 30, "min_orders": 2, "max_orders": 4 }`  
  `GET /planned_trip`：返回当前设定；`DELETE /planned_trip`：清除。

示例（curl）：

```bash
curl -X PUT https://api.yourdomain.com/driver_mode -H "Content-Type: application/json" -d "{\"mode\":\"mode2\"}"
curl -X PUT https://api.yourdomain.com/driver_mode_config -H "Content-Type: application/json" -d "{\"mode2_detour_max\":60,\"mode3_max_minutes_to_pickup\":20,\"mode3_max_detour_minutes\":30}"
```

---

## 网页上怎么切（前端代码片段）

在 Cloudflare 网页里加一块「调度模式」区域，并填对你的 API 基础地址：

```html
<div class="card">
  <h2>调度模式</h2>
  <p id="modeStatus">当前：加载中…</p>
  <button data-mode="mode1">出发前找单</button>
  <button data-mode="mode2">路上接满</button>
  <button data-mode="mode3">送人后周边</button>
  <button data-mode="pause">停止接单</button>
</div>

<script>
(function() {
  var API_BASE = "https://api.yourdomain.com";  // 改成你的 API 地址
  var statusEl = document.getElementById("modeStatus");
  var labels = { mode1: "出发前找单", mode2: "路上接满", mode3: "送人后周边", pause: "停止接单" };

  function refreshMode() {
    fetch(API_BASE + "/driver_mode")
      .then(function(r) { return r.json(); })
      .then(function(d) {
        statusEl.textContent = "当前：" + (labels[d.mode] || d.mode);
      })
      .catch(function() { statusEl.textContent = "当前：获取失败"; });
  }

  [].forEach.call(document.querySelectorAll("[data-mode]"), function(btn) {
    btn.onclick = function() {
      var mode = this.getAttribute("data-mode");
      fetch(API_BASE + "/driver_mode", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mode: mode })
      }).then(function() { refreshMode(); });
    };
  });

  refreshMode();
})();
</script>
```

把上面的 `API_BASE` 改成你大脑的地址（例如 Cloudflare 代理后的 `https://api.yourdomain.com`），页面加载时会显示当前模式，点按钮即可切换。

---

## 用 iPhone 快捷指令切换

1. 新建「快捷指令」。
2. 添加「获取 URL 内容」：  
   URL 填 `https://api.yourdomain.com/driver_mode`，方法选 **PUT**，请求体选 **JSON**， body 填 `{"mode":"pause"}`（可改成 `smart` / `all`）。
3. 可再做四个快捷指令分别对应 `mode1`、`mode2`、`mode3`、`pause`，放到桌面或小组件，一键切换。

这样不用打开网页也能切模式。

---

## 多司机 + Supabase 时怎么扩展

当前是单司机、模式和参数存在内存里。若以后接 Supabase 多司机：

- 每个司机在 `driver_state` 表里有一条记录，其中有 `mode` 字段；模式参数可存同一张表或单独配置表。
- 切换模式时改为：`PUT /driver_mode` 带 `driver_id`，后端去 Supabase 更新 `driver_state.mode`。
- 评估订单时按 `driver_id` 查当前司机的 `mode` 及对应参数，再分支（mode1 / mode2 / mode3 / pause）。

表结构你已经有了，只需把「读/写模式与参数」从内存改成读写在 Supabase 即可。

# 三种业务模式重塑 — 规格说明

## 总览

| 模式 | 场景 | AI 要做的事 |
|------|------|-------------|
| **模式1** | 还没开始跑，提前规划 | 盯规定时间附近、方向一致的订单（如 6 点 如东→上海），在**路上时间最短、收益最高**前提下，选 **2～4 笔** 订单组成行程。 |
| **模式2** | 已经在跑，车没满 | 在**规定耽误时间内**（如 20 分钟～1 小时）接满顺路单；**收益特别高**时允许最后送该客人（多绕一点）。 |
| **模式3** | 送完一个人 | 以**当前所在位置**为圆心，只在**规定时效内**（如 10～30 分钟）能接上的单才考虑，接单后**重新规划整条线路**。 |

---

## 模式1：出发前找单（规划日/班次）

### 业务场景

- 你**还没出发**，例如第二天早上 6 点从家里（如东荣生花苑）到上海。
- 希望 AI **提前盯紧**：在规定时间附近、方向为「如东 → 上海」的订单。
- 目标：**路上时间最短 + 收益最高**，且接 **2～4 位客人**（2～4 笔订单）。

### 输入（你设定的规划）

- **出发地**：如东荣生花苑（或更细地址）。
- **目的地**：上海（可为一区/一点，如「上海市」或「上海虹桥」）。
- **计划出发时间**：如 6:00，可带**时间窗**（如 5:30～6:30）。
- **目标人数**：最少 2 人、最多 4 人（即 2～4 笔订单）。

### AI 逻辑（系统侧）

1. **盯单 / 筛单**  
   只关注：**出发时间在时间窗内**、**起点在出发地附近**、**终点在目的地方向/范围内**的订单（由探针抓取后写入订单池，或由单独「规划任务」筛选）。
2. **组合优化**  
   在满足 2～4 笔订单的前提下，在所有可行组合里选出一组，使得：
   - **总路程/总时间尽量短**；
   - **总收益尽量高**。  
   可做成「多目标」：先保证时间最短，再在时间相近的组合里选收益最高；或你指定优先级。
3. **输出**  
   给出「推荐接的 2～4 笔订单」+「推荐接人/送人顺序」+「预估总时间、总收益」，供你出发前或出发时参考、抢单。

### 与现有系统的关系

- 探针持续把大厅订单上报到**订单池**（或带标签「如东→上海」「时间窗」）。
- 后端提供**规划任务**（如：创建「明早 6 点 如东→上海，2～4 单」），并定时或按需对订单池做**批量优化**，得到推荐组合与顺序。
- 模式1 是「**找单 + 组合优化**」，与模式2/3 的「**单笔实时评估 + PDP**」共用订单池和地图接口，但入口与参数不同。

---

## 模式2：路上接满（车未满、规定耽误内）

### 业务场景

- 你**已经在跑**，车上还有空座。
- 希望在**规定耽误时间内**（如 20 分钟～1 小时）再接**顺路单**，把车接满。
- **特殊规则**：若某单**收益特别高**，可以接受「最后送这位客人」（即多绕一点路、耽误时间可放宽到上限）。

### 输入（当前状态 + 策略参数）

- **当前状态**：司机当前位置、已接订单的起终点列表（与现有 `CurrentState` 一致）。
- **策略参数**：  
  - **最小/最大允许耽误时间**：如 20 分钟～60 分钟（可配置）；  
  - **高收益门槛**：如「单价 ≥ 100 元」视为高收益，可放宽到「最后送」或占用「最大耽误时间」。

### AI 逻辑（系统侧）

1. 每来一单，用现有 **PDP** 算「接这单」的新路线与**新增耽误时间**（绕路时间）。
2. **基础规则**：  
   - 若新增耽误时间 **≤ 你设的最大允许耽误**（如 60 分钟），且当前模式为模式2，则视为可接，推 Bark。  
   - 若在 **最小～最大** 之间（如 20～60 分钟），也按「顺路」处理，可推送。
3. **高收益放宽**：  
   - 若该单价格 **≥ 高收益门槛**，则允许占用「最大耽误时间」甚至「最后送该客人」（即该单的送客点排在路线最后），仍推送；否则按普通顺路单用 20～60 分钟卡。

### 与现有接口的关系

- 沿用 **`/evaluate_new_order`**：传入 `current_state` + `new_order`。
- 模式2 下，后端使用**可配置的耽误时间范围**（如 20～60 分钟）和**高收益门槛**做判定，而不是固定 15 分钟。

---

## 模式3：送人前预估 + 周边时效 + 剩余路线顺路（提前推送，可串行）

### 业务场景

- 你**还在送当前客人**，系统**不等你送完再找单**，而是：
  - **根据你导航速度预估**「即将放下客人的时间与地点」；
  - 在**该时间、该地点附近**寻找顺路单；
  - 考虑**剩余路线的顺路程度**（接这单对剩余路线不能耽误太久），满足则**提前推送**，方便你送完人后直接去接。
- **可串行重复**：送完第一位客人后你接了一单，等你要送这位新客人时，如果**周围又有合适的顺路单**，只要耽误在设定阈值内，可以再接。每次「即将送完当前客人」都会按同一规则找单，阈值需在后台设置好（耽误多久）。

### 输入（当前状态 + 策略参数）

- **当前状态**：  
  - **司机当前位置** = 导航中的实时位置（由网页/App 或端上定期上报）；  
  - **已接订单** = 当前剩余待接/待送点列表（含「即将送到的这位」；若你刚在上一轮接过一单，这里已包含该单的起终点）。
- **策略参数**（均可在接口中配置）：  
  - **接人时效**：如 10～30 分钟 —— 即「**预估送客点** → 新单起点」驾车时间 ≤ 此时效才考虑。  
  - **剩余路线耽误上限（耽误多久）**：如 25 分钟 —— 接该单对「送完当前客人之后的剩余路线」最多允许多绕的分钟数；**每次接单都按此阈值卡**，串行多次接单时同一阈值生效。

### AI 逻辑（系统侧）

1. **预估下一送客点**：  
   用「当前司机位置 → 各待送客点」的驾车时间，取**最近的一个送客点**作为「即将放下客人的地点」，其驾车时间作为**预估送达时间（ETA）**。
2. **附近时间与周围**：  
   只考虑「**预估送客点** → 新单起点」驾车时间 ≤ 接人时效的单（在该地点、该时间附近找顺路单）。
3. **剩余顺路程度**：  
   以「预估送客点」为虚拟起点，用 **PDP** 算「不接该单的剩余路线总耗时」与「接该单后的剩余路线总耗时」，**多出的时间**若超过「剩余路线耽误上限」则拒绝（不能耽误太久）。
4. **提前推送**：  
   通过则立即推送 Bark，并在返回里带上「预计约 X 分钟后在 Y 地送完当前客人」「该单起点距该处约 Z 分钟」「剩余路线仅多 W 分钟」等说明。

### 与现有接口的关系

- 仍用 **`/evaluate_new_order`**：  
  - `current_state.driver_loc` = 当前导航位置（不必等送完再更新）；  
  - `current_state.pickups` / `deliveries` = 当前剩余待接/待送（含正在送的那单；上一轮接的单已加入则这里会多一对起终点）。
- 后端在模式3 下：先算预估送客点与 ETA，再校验「预估送客点 → 新单起点」时效，最后用剩余路线 PDP 做耽误判定；**耽误上限**由 `mode3_max_detour_minutes` 控制，通过 **GET/PUT /driver_mode_config** 读取或修改。

---

## 小结：三种模式对比

| 维度 | 模式1 | 模式2 | 模式3 |
|------|--------|--------|--------|
| **时机** | 出发前 | 路上、车未满 | 送人中（提前匹配） |
| **司机位置** | 出发地（家） | 当前行驶位置 | 当前导航位置（用于预估下一送客点） |
| **核心目标** | 时间最短 + 收益最高，2～4 单 | 规定耽误内接满顺路单，高收益可放宽 | 预估放下客人时间与地点，在该时间/地点附近找顺路单，剩余路线不能耽误太久 |
| **主要参数** | 出发地、目的地、时间窗、2～4 单 | 耽误时间范围（如 20～60 分钟）、高收益门槛 | 接人时效（预估送客点→新单起点）、剩余路线耽误上限 |
| **接口形态** | 规划任务 + 订单池 + 批量优化 | 单笔 `/evaluate_new_order`，可配置耽误与高收益 | 单笔 `/evaluate_new_order`，预估送客点→时效→剩余路线 PDP |

后端实现时：**模式2、模式3** 可直接在现有「单笔评估 + PDP」上扩展参数与分支；**模式1** 需要「规划任务 + 订单池筛选 + 批量组合优化」一套新流程，可与现有探针和订单池对接后分步实现。

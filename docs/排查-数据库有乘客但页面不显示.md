# 排查：数据库有 4 个乘客但页面显示「暂无乘客」

## 原因说明（按数据流）

页面「当前车上乘客」来自：**Supabase `order_pool` 表**，查询条件为：

- `assigned_driver_id` = 当前司机的 UUID（来自 config.js 的 `driverId` 或默认值）
- `status` = `'assigned'`

只要**上面两个条件在库里对不上**，或**根本没查到 Supabase**，页面就会显示 0 个乘客。

---

## 可能原因与对应检查

### 1. Supabase 客户端没建起来（没发请求）

- **表现**：`getSupabaseClient()` 为 `null`，不会请求 `order_pool`，只从 localStorage 读（通常为空）→ 显示 0 人。
- **常见情况**：  
  - 未登录或 session 失效，且 **localStorage 里没有 Supabase URL / anon key**；  
  - 或 **config.js 没加载**（例如用 `file://` 打开、路径错、被拦截），页面上拿不到 `supabaseUrl` / `supabaseAnonKey`。
- **检查**：  
  - 是否从 **登录页** 正常登录后再进控制台；  
  - 用 **http(s)** 打开页面，确保和 `config.js` 同源、能加载；  
  - 控制台 F12 → Console，看是否有 `config.js` 或 Supabase 相关报错。

### 2. 请求发了但失败（走 .catch）

- **表现**：请求 Supabase 报错（网络、401、403 等），前端走 `loadFromDb` 的 `.catch()`，不会更新乘客列表 → 仍显示 0 人。
- **常见情况**：  
  - **anon key 错误**（401）；  
  - **RLS 策略** 不允许 anon 读 `order_pool`（403 或空结果）；  
  - 网络/CORS 问题。
- **检查**：  
  - 打开 F12 → Console，看是否有 **红色报错**（例如 `Failed to fetch`、`401`、`403`）；  
  - 在 **Supabase Dashboard → API** 确认 anon key 与 config.js 里 `supabaseAnonKey` 一致；  
  - 确认已执行 **007** 迁移，且存在策略：  
    `anon_all_order_pool` 对 `order_pool` 的 SELECT 允许 anon。

### 3. 请求成功但返回 0 行（条件对不上）

- **表现**：Supabase 请求成功，但 `order_pool` 里没有满足「本司机 + assigned」的订单。
- **常见情况**：  
  - 库里 4 条订单的 **`assigned_driver_id`** 不是当前页用的 **driverId**（例如 seed 没跑、或改过司机 UUID）；  
  - 或这 4 条的 **`status`** 不是 `'assigned'`（例如被改成了 `completed` / `pending_match`）。
- **检查（在 Supabase SQL Editor 执行）**：

```sql
-- 当前控制台用的司机 ID（与 config.js / seed 一致）
SELECT 'a0000001-0000-4000-8000-000000000001' AS expected_driver_id;

-- 有多少条订单的 assigned_driver_id 等于该司机？
SELECT COUNT(*) AS cnt
FROM order_pool
WHERE assigned_driver_id = 'a0000001-0000-4000-8000-000000000001';

-- 其中 status = 'assigned' 的有多少？（页面只认这一种）
SELECT status, COUNT(*) AS cnt
FROM order_pool
WHERE assigned_driver_id = 'a0000001-0000-4000-8000-000000000001'
GROUP BY status;
```

- 若第一条 COUNT 是 0：说明没有订单挂在这个司机下，需要重新跑 **006 种子** 或 **008 修复脚本**，把 4 条订单的 `assigned_driver_id` 设成该 UUID。  
- 若第一条 COUNT 是 4 但 `status = 'assigned'` 的条数是 0：把这 4 条改回 assigned：

```sql
UPDATE order_pool
SET status = 'assigned'
WHERE assigned_driver_id = 'a0000001-0000-4000-8000-000000000001';
```

---

## 小结

| 现象 | 最可能原因 | 建议动作 |
|------|------------|----------|
| 一直 0 人、F12 无报错 | Supabase 客户端未创建（config 未加载或 URL/anon 为空） | 用 http 打开、确保 config.js 同目录且加载；登录后确认 localStorage 有 url/anon |
| 一直 0 人、F12 有 401/403 或 fetch 报错 | anon key 错或 RLS 禁止 anon 读 | 核对 anon key、检查 order_pool 的 RLS 策略 |
| 库里明显有 4 条「本司机」订单仍 0 人 | 这 4 条 status 不是 `assigned`，或 assigned_driver_id 与 config 的 driverId 不一致 | 用上面 SQL 查 status/assigned_driver_id，按 008 或 SQL 修正 |

按上面顺序查：先确认「请求有没有发、有没有报错」，再确认「库里 assigned_driver_id + status 是否和页面条件一致」。

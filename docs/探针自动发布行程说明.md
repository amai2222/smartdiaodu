# 探针自动发布行程：从「第一个客人下车点」找顺路单

## 逻辑背景

在**模式2（路上接满）**下，你希望从**第一个客人下车点**往后找顺路单。部分顺风车平台（如哈啰、滴滴）的规则是：

- 只有司机在 App 里**先发布行程**（填起点、终点、出发时间），平台才会按这条路线推荐/展示**顺路单**；
- 若从不发布，大厅里看到的可能是全量订单，而不是「沿你当前路线」的匹配结果。

所以：**需要探针号在 Root 安卓机上自动完成「发布行程」**，这样平台会按你当前路线展示顺路单，抓单脚本再把这些订单上报给大脑评估。

---

## 能否实现？

**可以。** 分两块：

1. **大脑**：根据你当前的司机位置 + 已接订单，用 PDP 算出最优路线，再从中提取「**第一个客人下车点**」和「**最后一站**」，作为「建议发布的行程」返回给探针。
2. **探针**：定时请求大脑拿到 `origin`、`destination`、`depart_time`，在 App 的「发布行程」页用 **UI 自动化**（AutoX.js 或 UIAutomator2）自动填起点、终点、时间并点击发布。

这样**不需要你手动机上操作**，探针号会自动按当前路线发布行程，从而看到该路线的顺路单。

---

## 后端接口（已实现）

**POST /probe_publish_trip**

- 请求体：`{ "current_state": { "driver_loc", "pickups", "deliveries" } }`（与评估接口一致）。
- 返回示例：
  - `origin`：建议起点（**第一个客人下车点**，即路线顺序里第一个 delivery）；
  - `destination`：建议终点（路线最后一站）；
  - `depart_time`：当前服务器时间格式化的出发时间（如 "14:30"），探针可用来填表或改用本地时间；
  - `hint`：说明文案。

若当前没有已接单，则返回起点=终点=司机位置，探针可选择不发布或按需处理。

---

## 探针端脚本（模板）

- **autox_publish_trip.js**：在 Root 安卓上运行，轮询 `POST /probe_publish_trip`，拿到 `origin/destination/depart_time` 后，用选择器在「发布行程」页填表并点发布。
- 使用前**必须**用布局分析找到该 App「发布行程」页的**起点输入框、终点输入框、出发时间控件、发布按钮**，把脚本里的 `SELECTORS` 改成实际 id/文本/层级（和抓单脚本一样，因 App 而异）。

是否必须跑这个脚本，取决于平台：若你实测**不发布就看不到沿路顺路单**，再启用即可；若大厅本来就会按位置推荐，可以只跑抓单脚本。

---

## 接单后取消探针已发布行程

**逻辑**：司机在网页/链接上点击「接单」后，大脑会置位「取消探针已发布行程」；探针下次轮询 **POST /probe_publish_trip** 时，响应里会多一个 **cancel_current_trip: true**，探针脚本在 App 内执行「进入我的行程/已发布 → 点取消 → 确认」即可把探针号刚发布的行程取消掉。

- **后端**：在 **GET /order_response** 里，当 `accepted=1`（接单）时设置 `probe_cancel_trip_requested = True`；在 **POST /probe_publish_trip** 的返回里若该标志为真，则附带 `cancel_current_trip: true` 并清除标志（只生效一次）。
- **探针**：`autox_publish_trip.js` 收到 `cancel_current_trip: true` 时先调用 `cancelCurrentTripInApp()`（用 CANCEL_SELECTORS 找到「我的行程/已发布」入口和「取消」按钮并点击），再继续下一轮轮询；下一轮会拿到新的建议行程，可按需再发布。

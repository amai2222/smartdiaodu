# 探子多订单筛选逻辑 — 将来方案

本文描述**当前**探子与大脑的协作方式，以及**将来**「多订单筛选」的推荐逻辑与接口形态（含模式1 规划任务 + 批量优化）。

---

## 一、当前逻辑（单笔上报）

### 探子端（probe）

- **uiautomator2_capture.py**：从顺风车大厅**每次只取一条**订单（`extract_one_order`），得到 `pickup / delivery / price`。
- 简单去重：用 `pickup_delivery_price` 的 MD5 与上一条比较，避免同一屏重复上报。
- 每间隔约 1.2 秒轮询一次，抓到一条就 **POST /evaluate_new_order**，请求体为 `current_state` + `new_order`（单笔）。

### 大脑端（smartdiaodu.py）

- **/evaluate_new_order**：只接收**一个**新订单，与当前行程做「接 vs 不接」的对比：
  - 地理编码 → 路网矩阵 → **PDP 规划**（不接的总时间 vs 接后的总时间）；
  - 根据模式与参数（绕路阈值、高收益门槛、模式3 时效等）决定 **matched / rejected / ignored**；
  - 若 matched 则推 Bark / Supabase Realtime。
- **模式1** 下直接返回：`"请使用规划任务接口筛选并批量优化 2～4 单"`，即**不对单笔做接单决策**，也不做多订单组合。

### 缺口

- 探子没有「一屏多单」或「一段时间内多单」的**批量上报**。
- 后端没有「给定一批候选订单 + 计划（起终点、2～4 单）」的**批量筛选与组合优化**接口，即「规划任务接口」尚未实现。

---

## 二、将来：多订单筛选与组合优化

目标：探子能提供**多笔候选订单**，大脑在**满足计划约束**（如 2～4 单、起终点方向）的前提下，选出**最优子集**并给出**接人/送人顺序**（仍用现有 PDP）。

### 2.1 探子侧扩展（将来）

- **方案 A**：一屏多单  
  - 用 UIAutomator2 解析列表页，一次提取**当前屏所有订单**（如 5～10 条），得到 `orders: [{pickup, delivery, price}, ...]`。  
  - 按计划（见下）只在上报前做简单过滤（如起终点关键词），然后**整批** POST 到大脑新接口。
- **方案 B**：时间窗聚合  
  - 仍每次抓一条或少量，在探子本地先**缓存**（如 30～60 秒内的所有不同订单）；  
  - 到达时间或条数阈值后，**整批**上报大脑，由大脑做筛选与组合。

两种方案可并存：A 适合「一屏多单」的 App，B 适合「一屏一单、滚动加载」的 App。

### 2.2 大脑侧新接口（将来）

建议新增**规划任务 + 批量筛选**接口，例如：

- **POST /plan_task** 或 **POST /evaluate_orders_batch**  
- **请求体**（示例）：
  - `plan`：`{ origin, destination, departure_time?, time_window_minutes?, min_orders, max_orders }`（与现有 `planned_trip` 一致）；
  - `candidates`：`[{ pickup, delivery, price }, ...]`，探子上报的**候选订单列表**。
- **响应**：
  - `selected`：选中的 2～4 笔订单（子集）；
  - `route_addresses` / `route_coords` / `point_types` / `point_labels`：推荐接送顺序（与现有 `current_route_preview` 同构）；
  - `total_time_seconds`、`total_profit` 等可选。

### 2.3 多订单筛选与组合逻辑（推荐）

在「候选订单 + 计划约束」下，要解决的是：**从 candidates 里选一个子集 S，满足 min_orders ≤ |S| ≤ max_orders，且 S 的 PDP 总时间（或总收益/时间比）最优**。

可选实现方式：

1. **枚举子集 + PDP（小规模推荐）**  
   - 对每个满足 `min_orders ≤ k ≤ max_orders` 的 k，枚举所有 k 元子集（若候选数较多可先按「顺路程度」粗筛再枚举）；  
   - 对每个子集构造 `addresses = [origin] + pickups + deliveries`，调用现有 `get_duration_matrix` + `solve_pdp_route`；  
   - 在得到可行路线的子集中，按**总时间最短**或**收益/时间比最大**选出一组，返回其 `route_indices` 与对应地址/坐标。

2. **贪心 / 启发式（候选很多时）**  
   - 从空集开始，每次加入「边际绕路最小」或「边际收益/边际时间最大」的一单，直到达到 `max_orders` 或无法再改善目标；  
   - 再对已选子集跑一次 PDP 得到最终顺序；  
   - 若子集大小小于 `min_orders`，可放宽约束或返回「本批无满足条件的组合」。

3. **与现有 PDP 一致**  
   - 无论枚举还是贪心，**顺序优化**都沿用现有 `solve_pdp_route`（先接后送、总时间最小）；  
   - 仅「选哪几单」是多订单筛选层；「选完后的顺序」完全由 PDP 决定。

### 2.4 与模式1 的关系

- 模式1 的「下次计划」已包含：`origin, destination, departure_time, min_orders, max_orders`。  
- 将来的**多订单筛选** = 在探子上报的 `candidates` 上，按**当前第一条未完成的计划**的约束，做上述子集选择 + PDP，得到「推荐接的 2～4 单 + 推荐顺序」。  
- 探子或调度端可轮询：**GET /planned_trip** 取当前计划 → 抓单/聚单 → **POST /plan_task**（或 `/evaluate_orders_batch`）带 `plan` + `candidates`，再用返回的 `selected` + `route_*` 做展示或自动抢单。

---

## 三、小结

| 项目 | 当前 | 将来（建议） |
|------|------|----------------|
| 探子 | 每次 1 单，POST /evaluate_new_order | 一屏多单或时间窗聚合，整批 POST 新接口 |
| 大脑 | 单笔评估 + PDP；模式1 仅提示用规划任务 | 新接口：接收 plan + candidates，子集筛选 + PDP，返回 selected + route |
| 筛选逻辑 | 无多订单组合 | 枚举子集 + PDP，或贪心 + PDP，目标为总时间最短或收益/时间最优 |

实现时，**多订单筛选**只需在现有 `geocode_addresses`、`get_duration_matrix`、`solve_pdp_route` 之上增加「候选子集枚举/贪心 + 调用 PDP」即可，无需改动 PDP 本身。

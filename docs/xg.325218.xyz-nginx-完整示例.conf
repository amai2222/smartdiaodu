# xg.325218.xyz 完整 Nginx 配置（443 + 80 跳转 + 88 API + /api/ 反代）
# 用法：放到 /etc/nginx/conf.d/ 下（如 v2ray.conf），然后 nginx -t && systemctl start nginx 或 nginx -s reload
# 若报 invalid PID number：说明 Nginx 未在跑，先执行 systemctl start nginx 或 nginx

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name xg.325218.xyz;

    ssl_certificate     /data/v2ray.crt;
    ssl_certificate_key /data/v2ray.key;
    ssl_protocols       TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers         TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;

    # ssl_early_data / ssl_stapling 已去掉：当前环境不支持 0-RTT；证书无 OCSP 会报 warn
    add_header Strict-Transport-Security "max-age=31536000";

    index index.html index.htm;
    root /home/wwwroot/3DCEList;
    error_page 400 = /400.html;

    # 原有：某服务
    location /8d0bbc7e1f/ {
        proxy_redirect off;
        proxy_pass http://127.0.0.1:23640;
        proxy_http_version 1.1;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
    }

    # 智能调度 API：/api/ 反代到本机 8000（与 88 端口后端同一服务）
    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

}

server {
    listen 80;
    listen [::]:80;
    server_name xg.325218.xyz;
    return 301 https://xg.325218.xyz$request_uri;
}

# 88 端口：直接访问 API（可选，与 /api/ 二选一或并存）
server {
    listen 88;
    listen [::]:88;
    server_name xg.325218.xyz;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

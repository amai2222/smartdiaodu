# 规划线路实现说明 · 如何在地图上查看

## 一、规划线路是哪个部分实现的？

规划线路分三块：**后端算路**、**接口**、**前端地图展示**。

### 1. 后端算路（`smartdiaodu.py`）

| 位置 | 作用 |
|------|------|
| **地理编码** | `geocode_address` / `geocode_addresses`：地址 → 百度坐标（用于算距离与画图） |
| **耗时矩阵** | `get_duration_matrix(coords)`：任意两点驾车时间（秒），用于 PDP 输入 |
| **PDP 算法** | `solve_pdp_route(matrix, num_pickup_delivery_pairs)`（约 407～462 行）<br>OR-Tools 带「先接后送」约束的车辆路径规划，得到**途经点顺序**和**总耗时** |
| **路线预览接口** | `POST /current_route_preview`（约 745～817 行）<br>入参：`{ "current_state": { "driver_loc", "pickups", "deliveries" } }`<br>内部：地址列表 → 地理编码 → 耗时矩阵 → PDP 求最优顺序 → 转 WGS84 经纬度<br>出参：`route_addresses`、`route_coords`、`point_types`、`point_labels`、`total_time_seconds` |

也就是说：**规划线路的逻辑** = 地理编码 + 耗时矩阵 + **OR-Tools PDP**（`solve_pdp_route`）+ **`/current_route_preview`** 把结果整理成「途经点顺序 + 经纬度」返回。

### 2. 前端地图展示（`web/map.html`）

- 打开地图页时先**从 Supabase 拉当前计划**：司机位置 + 已分配订单的接/送地址（`loadStateFromSupabase`）。
- 用这份 `current_state` 调用 **`POST /current_route_preview`**，拿到 `route_addresses`、`route_coords` 等。
- 用百度地图 API 在 `#map` 上画**折线**和**途经点标记**（`drawRouteFromIndex`），并显示「下一站」「打开导航」「已到达」。

所以：**在地图上看到的“规划好的线路”** = 后端 `/current_route_preview` 算出的顺序 + 前端用 `route_coords` 在百度地图上画的线和点。

---

## 二、如何在地图上查看规划好的线路？

1. **确保数据库里有当前计划**  
   - `driver_state`：该司机的 `current_loc`（起点）。  
   - `order_pool`：该司机、`status = 'assigned'` 的订单，每条有 `pickup`、`delivery`。

2. **打开地图页**  
   - 从控制台点 **「显示地图」** 进入 `map.html`，或直接打开 `web/map.html`。  
   - 页面会先提示「从数据库加载计划…」→「规划路线中…」。

3. **看到的内容**  
   - 百度地图上会画出：**司机起点 → 各接客点 → 各送客点** 的**折线**和**站点标记**（含“司机”“乘客1起点/终点”等标签）。  
   - 顶部状态会显示「共 N 站，约 M 分钟」。  
   - 底部有「下一站」「打开导航（百度地图）」「已到达」；点「已到达」会推进到下一站并更新数据库。

4. **若没有线或只有一点**  
   - 检查 `config.js` 里 `apiBase`、`baiduMapAk` 是否配置正确（地图页会请求后端并画图）。  
   - 检查 Supabase 里该司机是否有 `status = 'assigned'` 的订单；没有则只有司机一个点。  
   - 点一次 **「更新路线」** 会重新从数据库拉计划并重新请求 `/current_route_preview` 再画一遍。

---

## 三、数据流小结

```
Supabase (driver_state + order_pool 已分配)
    → map.html loadStateFromSupabase() 得到 driver_loc + pickups + deliveries
    → POST /current_route_preview { current_state }
    → 后端 geocode + 耗时矩阵 + solve_pdp_route 得到最优顺序
    → 返回 route_addresses, route_coords, point_types, point_labels
    → map.html drawRouteFromIndex() 在百度地图上画折线 + 标记
```

你要「在地图上查看规划好的线路」：**打开地图页即可**；线路 = 后端 PDP 规划结果在前端百度地图上的可视化。

---

## 四、规划结果入库与恢复上次线路

- **入库**：每次调用 `POST /current_route_preview` 得到规划结果后，前端会把该结果写入 Supabase 表 **`driver_route_snapshot`**（每司机一条，按 `driver_id` 覆盖）。字段包括：`route_addresses`、`route_coords`、`point_types`、`point_labels`、`total_time_seconds`。
- **恢复上次线路**：  
  - 打开地图页时，会**先查** `driver_route_snapshot` 是否有该司机的快照；若有则直接用来画图，并提示「已恢复上次线路（共 N 站…）」；若无再走「从数据库加载计划 → 请求规划 → 画图并入库」。  
  - 工具栏有 **「恢复上次线路」** 按钮：从库中读出上次保存的快照并重新画图；若无快照则提示「无已保存线路，请先点『更新路线』规划并入库」。
